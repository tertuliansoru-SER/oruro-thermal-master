<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OTM 120H - Oruro Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;900&display=swap');
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: #020617; color: white; overflow-x: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .view { display: none; min-height: 100vh; width: 100%; flex-direction: column; }
        .view.active { display: flex; }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 50% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } }
        @keyframes pulse-lime { 0%, 100% { box-shadow: 0 0 0 0 rgba(132, 204, 22, 0.7); } 50% { box-shadow: 0 0 0 20px rgba(132, 204, 22, 0); } }
        .led-red { animation: pulse-red 2s infinite; background: #ef4444; }
        .led-lime { animation: pulse-lime 2s infinite; background: #84cc16; }
        .data-table { font-size: 11px; width: 100%; border-collapse: collapse; }
        .data-table th { background: #1e293b; padding: 10px; text-align: left; position: sticky; top: 0; }
        .data-table td { padding: 10px; border-bottom: 1px solid #334155; }
    </style>
</head>
<body>

<!-- PANTALLA PRINCIPAL (OPERADOR) -->
<div id="view-public" class="view active p-4">
    <header class="flex justify-between items-center bg-slate-900 p-5 rounded-3xl border border-slate-800 mb-4 shadow-2xl">
        <div>
            <h1 class="text-2xl font-black italic tracking-tighter leading-none">OTM <span class="text-lime-400">120H</span></h1>
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Planta Oruro ‚Ä¢ 3,700 msnm</p>
        </div>
        <div class="flex items-center gap-3">
            <div id="sync-status" class="text-[8px] font-black text-slate-600 uppercase">Sincronizando...</div>
            <div id="led-main" class="w-4 h-4 rounded-full bg-slate-700"></div>
        </div>
    </header>

    <!-- ALERTA GIRO (INCHING) -->
    <div id="alert-inching" class="hidden mb-4 p-5 bg-red-600 rounded-3xl border-2 border-red-400 text-center animate-pulse">
        <div class="text-2xl mb-1">‚ö†Ô∏è</div>
        <div class="text-sm font-black uppercase mb-3">¬°Girar Horno 90¬∞ Ahora!</div>
        <button onclick="confirmarGiro()" class="w-full py-3 bg-white text-red-900 font-black uppercase rounded-xl active:scale-95 transition-all">Confirmar Giro</button>
    </div>

    <!-- MONITOR CENTRAL -->
    <div class="bg-slate-900/50 border border-slate-800 rounded-[2.5rem] p-8 text-center mb-4 shadow-2xl relative">
        <div id="phase-badge" class="absolute top-4 right-4 px-3 py-1 bg-slate-800 rounded-full text-[10px] font-bold text-slate-500 uppercase">Fase 1</div>
        <div id="clock-main" class="mono text-6xl font-bold text-white mb-2 tracking-tighter">00:00:00</div>
        <div id="status-badge" class="inline-block px-3 py-1 bg-slate-800 text-slate-400 rounded-full text-[10px] font-black uppercase tracking-widest italic">Sistema Pausado</div>
    </div>

    <!-- M√âTRICAS -->
    <div class="grid grid-cols-2 gap-3 mb-4">
        <div class="bg-slate-900 p-5 rounded-[2rem] border border-slate-800 text-center">
            <p class="text-[9px] font-bold text-slate-500 uppercase mb-1">Temp Interna</p>
            <p id="val-temp" class="text-4xl font-black text-lime-400 mono">--¬∞C</p>
        </div>
        <div class="bg-slate-900 p-5 rounded-[2rem] border border-slate-800 text-center">
            <p class="text-[9px] font-bold text-slate-500 uppercase mb-1">Presi√≥n Draft</p>
            <p id="val-press" class="text-4xl font-black text-sky-400 mono">--</p>
        </div>
    </div>

    <!-- TIMER GIRO -->
    <div class="bg-slate-950 border border-slate-800 rounded-2xl p-4 mb-4 flex justify-between items-center">
        <div>
            <p class="text-[10px] font-bold text-orange-400 uppercase mb-1 italic">Pr√≥ximo Giro 90¬∞</p>
            <p id="inch-timer" class="text-2xl font-black text-white mono">--:--</p>
        </div>
        <div class="text-right">
            <p class="text-[9px] text-slate-600 uppercase">√öltimo giro</p>
            <p id="last-inch" class="text-xs font-bold text-slate-400">00:00:00</p>
        </div>
    </div>

    <!-- SECCI√ìN TURNO -->
    <div id="section-turno" class="bg-slate-900 rounded-3xl p-5 border border-slate-800 mb-4">
        <div id="form-turno">
            <h3 class="text-xs font-bold text-blue-400 uppercase mb-3 italic tracking-widest">üîÑ Cambio de Turno</h3>
            <input type="text" id="in-nombre" class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white mb-3 uppercase font-bold outline-none" placeholder="Nombre Operador">
            <div class="grid grid-cols-2 gap-3 mb-3">
                <input type="time" id="in-hora" class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white font-bold">
                <select id="in-punta" class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white font-bold">
                    <option value="1">1ra Punta</option><option value="2">2da Punta</option><option value="3">3ra Punta</option>
                </select>
            </div>
            <button onclick="iniciarTurno()" class="w-full py-3 bg-blue-600 text-white font-black rounded-xl uppercase text-sm active:scale-95 transition-all">Iniciar Mi Turno</button>
        </div>
        <div id="display-turno" class="hidden">
            <div class="bg-gradient-to-r from-blue-700 to-blue-500 rounded-2xl p-4 mb-3 text-center shadow-lg">
                <p id="txt-operador" class="text-xl font-black text-white uppercase tracking-tighter">--</p>
                <p id="txt-info" class="text-[10px] text-blue-100 uppercase mt-1">Punta -- | Ingreso --</p>
            </div>
            <button onclick="cerrarTurno()" class="w-full py-2 bg-slate-800 text-slate-400 font-bold rounded-xl text-[10px] uppercase">Finalizar Turno</button>
        </div>
    </div>

    <!-- REGISTRO DE DATOS -->
    <div id="section-registro" class="bg-slate-900 rounded-[2.5rem] p-6 border border-slate-800 mb-4 opacity-50 pointer-events-none transition-all duration-500">
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="bg-slate-950 p-4 rounded-3xl border border-slate-800">
                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 italic">Temp Casco</label>
                <input type="number" id="in-temp" class="w-full bg-transparent text-3xl font-black text-white outline-none mono" placeholder="0">
            </div>
            <div class="bg-slate-950 p-4 rounded-3xl border border-slate-800">
                <label class="block text-[10px] font-bold text-sky-500 uppercase mb-1 italic">Draft mmca</label>
                <input type="number" id="in-draft" step="0.1" class="w-full bg-transparent text-3xl font-black text-sky-400 outline-none mono" placeholder="0.0">
            </div>
        </div>
        <button onclick="guardarLectura()" class="w-full py-6 bg-lime-600 text-black font-black rounded-3xl uppercase text-lg shadow-xl active:scale-95">Guardar Lectura</button>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-4">
        <button onclick="showView('view-tabla')" class="py-4 bg-slate-800 text-blue-400 font-bold rounded-2xl uppercase text-[10px] border border-slate-700">üìä Ver Tabla</button>
        <button onclick="descargarCSV()" class="py-4 bg-slate-800 text-green-400 font-bold rounded-2xl uppercase text-[10px] border border-slate-700">‚¨áÔ∏è Exportar CSV</button>
    </div>

    <button onclick="showAdmin()" class="w-full mt-6 py-4 bg-slate-900 text-slate-600 font-bold rounded-2xl text-[10px] uppercase border border-slate-700">üîí Ingenier√≠a OTM</button>
</div>

<!-- VISTA TABLA -->
<div id="view-tabla" class="view p-4 bg-slate-950">
    <header class="flex justify-between items-center mb-4">
        <h2 class="text-blue-400 font-black uppercase text-sm italic">Base de Datos</h2>
        <button onclick="showView('view-public')" class="bg-slate-800 text-white px-5 py-2 rounded-xl text-[10px] font-bold uppercase">Cerrar</button>
    </header>
    <div class="bg-slate-900 rounded-3xl overflow-hidden border border-slate-800 shadow-2xl flex-1 overflow-y-auto">
        <table class="data-table">
            <thead><tr><th>Reloj</th><th>Op</th><th>Casco</th><th>Int</th><th>Draft</th></tr></thead>
            <tbody id="table-body" class="mono"></tbody>
        </table>
    </div>
</div>

<!-- PANEL ADMIN -->
<div id="view-admin" class="view p-6 bg-slate-950 items-center justify-center">
    <div id="admin-login" class="w-full max-w-xs text-center">
        <h2 class="text-3xl font-black italic mb-8 uppercase tracking-tighter">Acceso <span class="text-lime-400">Jefe</span></h2>
        <input type="password" id="in-pin" class="w-full bg-slate-900 border-2 border-slate-700 p-6 rounded-[2rem] text-center text-4xl text-lime-400 font-bold mb-6 outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        <button onclick="validarPin()" class="w-full py-5 bg-lime-500 text-black font-black rounded-2xl uppercase text-lg shadow-xl active:scale-95">Entrar</button>
        <button onclick="showView('view-public')" class="mt-8 text-slate-500 font-bold uppercase text-[10px]">Cancelar</button>
    </div>

    <div id="admin-panel" class="hidden w-full h-full flex flex-col">
        <header class="flex justify-between items-center mb-6 w-full">
            <h2 class="text-lime-400 font-black italic uppercase text-sm">Control Maestro</h2>
            <button onclick="showView('view-public')" class="bg-red-900/30 text-red-500 px-5 py-2 rounded-xl text-[10px] font-bold uppercase">Salir</button>
        </header>
        <div class="bg-slate-900 border border-slate-800 rounded-[2.5rem] p-8 text-center mb-6 shadow-2xl w-full">
            <div id="admin-clock" class="mono text-5xl font-bold text-lime-400 mb-1 tracking-tighter">00:00:00</div>
            <p id="admin-status" class="text-[10px] font-black text-slate-500 uppercase tracking-widest italic">Sistema Pausado</p>
        </div>
        <button id="btn-master" onclick="toggleHornada()" class="w-full py-16 rounded-[3.5rem] bg-lime-500 text-black font-black text-4xl uppercase shadow-2xl active:scale-95 transition-all">INICIAR</button>
        <button onclick="resetTotal()" class="w-full mt-24 py-3 text-red-900 font-bold text-[9px] uppercase tracking-[0.5em] opacity-30">Reset Total de Hornada</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, orderBy, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = JSON.parse(__firebase_config);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'otm-120h-v4';
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let state = { running: false, startTS: null, lastRot: 0 };
    let logs = [];
    let user = null;
    let elapsed = 0;

    // --- BOOTSTRAP ---
    const init = async () => {
        await signInAnonymously(auth);
        onAuthStateChanged(auth, u => {
            if(u) {
                document.getElementById('sync-status').innerText = "ONLINE";
                document.getElementById('sync-status').classList.replace('text-slate-600', 'text-lime-500');
                sync();
            }
        });
    };

    const sync = () => {
        // Estado Maestro
        onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'master'), (snap) => {
            if(snap.exists()) {
                state = snap.data();
                updateUI();
            } else {
                setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), { running: false, startTS: null, lastRot: 0 });
            }
        });

        // Logs
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'registros'), orderBy('timestamp', 'desc'));
        onSnapshot(q, (snap) => {
            logs = snap.docs.map(d => d.data());
            renderTable();
            renderDashboard();
        });
    };

    // --- MOTOR DE TIEMPO ---
    setInterval(() => {
        if(state.running && state.startTS) {
            elapsed = Math.floor((Date.now() - state.startTS) / 1000);
            const timeStr = formatHMS(elapsed);
            document.getElementById('clock-main').innerText = timeStr;
            document.getElementById('admin-clock').innerText = timeStr;

            // Inching (15 min)
            const diff = elapsed - (state.lastRot || 0);
            const remain = Math.max(0, 900 - diff);
            document.getElementById('inch-timer').innerText = formatMS(remain);
            document.getElementById('alert-inching').classList.toggle('hidden', remain > 0);
            document.getElementById('last-inch').innerText = formatHMS(state.lastRot || 0);

            // Fases
            const hrs = elapsed / 3600;
            let f = "FASE 1: SECADO";
            if(hrs > 80) f = "FASE 3: VITRIFICADO";
            else if(hrs > 40) f = "FASE 2: QU√çMICO";
            document.getElementById('phase-badge').innerText = f;
        }
    }, 1000);

    // --- ACCIONES (GLOBALES) ---
    window.showView = (id) => {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo(0,0);
    };

    window.iniciarTurno = () => {
        const nom = document.getElementById('in-nombre').value.trim();
        if(!nom) return alert("Ingrese Nombre");
        user = { 
            nombre: nom.toUpperCase(), 
            hora: document.getElementById('in-hora').value, 
            punta: document.getElementById('in-punta').value 
        };
        document.getElementById('txt-operador').innerText = user.nombre;
        document.getElementById('txt-info').innerText = `Punta ${user.punta} | Ingreso: ${user.hora}`;
        document.getElementById('form-turno').classList.add('hidden');
        document.getElementById('display-turno').classList.remove('hidden');
        updateUI();
    };

    window.cerrarTurno = () => {
        user = null;
        document.getElementById('form-turno').classList.remove('hidden');
        document.getElementById('display-turno').classList.add('hidden');
        updateUI();
    };

    window.guardarLectura = async () => {
        const t = document.getElementById('in-temp').value;
        const d = document.getElementById('in-draft').value || 0;
        if(!t) return alert("Ingrese Temp");

        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'registros'), {
            timestamp: Date.now(),
            elapsed: elapsed,
            op: user.nombre,
            punta: user.punta,
            casco: parseFloat(t),
            int: Math.round(parseFloat(t) * 3.5),
            draft: parseFloat(d)
        });

        document.getElementById('in-temp').value = '';
        document.getElementById('in-draft').value = '';
    };

    window.confirmarGiro = async () => {
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), { ...state, lastRot: elapsed });
    };

    window.showAdmin = () => {
        document.getElementById('admin-login').classList.remove('hidden');
        document.getElementById('admin-panel').classList.add('hidden');
        showView('view-admin');
    };

    window.validarPin = () => {
        if(document.getElementById('in-pin').value === 'ORURO2026') {
            document.getElementById('admin-login').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
        } else alert("PIN Err√≥neo");
    };

    window.toggleHornada = async () => {
        const run = !state.running;
        const data = { running: run };
        if(run && !state.startTS) {
            data.startTS = Date.now();
            data.lastRot = 0;
        }
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), data, { merge: true });
    };

    window.resetTotal = async () => {
        if(!confirm("¬øBorrar todo?")) return;
        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), { running: false, startTS: null, lastRot: 0 });
        const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'registros'));
        for(const doc of snap.docs) await deleteDoc(doc.ref);
        location.reload();
    };

    // --- RENDERS ---
    function updateUI() {
        const led = document.getElementById('led-main');
        const badge = document.getElementById('status-badge');
        const btn = document.getElementById('btn-master');
        const admStatus = document.getElementById('admin-status');

        if(state.running) {
            led.className = "w-4 h-4 rounded-full led-lime";
            badge.innerText = "Hornada en Curso";
            badge.className = "inline-block px-3 py-1 bg-lime-900/30 text-lime-400 rounded-full text-[10px] font-black uppercase tracking-widest";
            if(btn) {
                btn.innerText = "PAUSAR";
                btn.className = "w-full py-16 rounded-[3.5rem] bg-zinc-800 text-zinc-400 font-black text-4xl uppercase";
                admStatus.innerText = "Sistema en Marcha";
                admStatus.className = "text-[10px] font-black text-lime-400 uppercase tracking-widest";
            }
        } else {
            led.className = "w-4 h-4 rounded-full led-red";
            badge.innerText = "Sistema Pausado";
            badge.className = "inline-block px-3 py-1 bg-slate-800 text-slate-500 rounded-full text-[10px] font-black uppercase tracking-widest";
            if(btn) {
                btn.innerText = "INICIAR";
                btn.className = "w-full py-16 rounded-[3.5rem] bg-lime-500 text-black font-black text-4xl uppercase shadow-2xl";
                admStatus.innerText = "Sistema Detenido";
                admStatus.className = "text-[10px] font-black text-slate-500 uppercase tracking-widest";
            }
        }

        const canReg = state.running && user;
        document.getElementById('section-registro').style.opacity = canReg ? "1" : "0.5";
        document.getElementById('section-registro').style.pointerEvents = canReg ? "auto" : "none";
    }

    function renderTable() {
        const body = document.getElementById('table-body');
        body.innerHTML = logs.map(l => `
            <tr>
                <td>${formatHMS(l.elapsed)}</td>
                <td class="font-bold">${l.op}</td>
                <td>${l.casco}¬∞</td>
                <td class="text-lime-400 font-bold">${l.int}¬∞</td>
                <td class="text-sky-400">${l.draft}</td>
            </tr>
        `).join('');
    }

    function renderDashboard() {
        const last = logs[0];
        if(last) {
            document.getElementById('val-temp').innerText = last.int + "¬∞C";
            document.getElementById('val-press').innerText = last.draft.toFixed(1);
        }
    }

    // --- UTIL ---
    function formatHMS(s) {
        const h = Math.floor(s/3600).toString().padStart(2,'0');
        const m = Math.floor((s%3600)/60).toString().padStart(2,'0');
        const sc = (s%60).toString().padStart(2,'0');
        return `${h}:${m}:${sc}`;
    }
    function formatMS(s) {
        co
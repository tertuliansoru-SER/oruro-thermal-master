<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- CONFIGURACIÓN DE ICONO Y PWA -->
    <title>OTM 120H Master</title>
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/240/fire-element.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/240/fire-element.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="OTM Oruro">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Inter:wght@400;700;900&display=swap');
        :root { 
            --bg: #020617; 
            --panel: #0f172a;
            --lime: #a3e635; 
            --amber: #fbbf24; 
            --red: #ef4444; 
            --blue: #38bdf8; 
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            color: #f1f5f9; 
            touch-action: manipulation;
            overscroll-behavior: none;
        }
        .digital { font-family: 'JetBrains Mono', monospace; }
        .glass { 
            background: rgba(15, 23, 42, 0.9); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(51, 65, 85, 0.5); 
        }
        .btn-press:active { transform: scale(0.96); opacity: 0.9; }
        @keyframes pulse-status { 0%, 100% { opacity: 1; box-shadow: 0 0 5px var(--lime); } 50% { opacity: 0.5; box-shadow: 0 0 20px var(--lime); } }
        .active-glow { animation: pulse-status 2s infinite; }
        .inching-alert { animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        
        /* Ocultar flechas de inputs numéricos */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 pb-12">

    <!-- MODAL DE ACCESO ADMIN -->
    <div id="login-modal" class="fixed inset-0 bg-black/95 z-[100] hidden flex items-center justify-center p-6 backdrop-blur-md">
        <div class="glass p-8 rounded-[2.5rem] w-full max-w-xs text-center border-lime-500/30">
            <h2 class="text-xl font-black mb-6 uppercase italic tracking-tighter text-white">Acceso de Ingeniería</h2>
            <input type="password" id="admin-pass" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-2xl text-center text-3xl mb-6 focus:border-lime-500 outline-none text-lime-400 font-black" placeholder="••••">
            <div class="flex gap-3">
                <button onclick="closeLogin()" class="flex-1 py-4 text-[10px] font-bold text-slate-500 uppercase">Cerrar</button>
                <button onclick="checkPass()" class="flex-1 py-4 bg-lime-500 text-black font-black rounded-2xl uppercase text-[10px]">Validar</button>
            </div>
        </div>
    </div>

    <!-- CABECERA DE ESTADO -->
    <header class="w-full max-w-lg flex justify-between items-center mb-4 bg-slate-900/80 p-5 rounded-3xl border border-slate-800 shadow-xl">
        <div class="flex items-center gap-3">
            <div id="led" class="w-3 h-3 rounded-full bg-red-600 transition-colors duration-500 shadow-[0_0_10px_red]"></div>
            <div>
                <h1 class="text-lg font-black italic tracking-tighter uppercase text-white">OTM <span class="text-lime-400">120H CLOUD</span></h1>
                <p id="role-text" class="text-[8px] font-bold text-slate-500 uppercase tracking-[0.3em]">Operador (Modo Sincronizado)</p>
            </div>
        </div>
        <button id="admin-btn" onclick="openLogin()" class="bg-slate-800 p-2.5 rounded-xl text-slate-500 hover:text-white transition-colors border border-slate-700">
            <i data-lucide="shield-check" size="20"></i>
        </button>
    </header>

    <main class="w-full max-w-lg space-y-4">
        
        <!-- DASHBOARD CENTRAL (RELOJ Y TEMPERATURAS) -->
        <div class="glass rounded-[2.5rem] p-8 text-center relative overflow-hidden shadow-2xl">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-slate-950">
                <div id="progress-bar" class="h-full bg-lime-500 transition-all duration-1000" style="width: 0%"></div>
            </div>
            
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-2 flex items-center justify-center gap-2">
                <i data-lucide="satellite" size="10" class="animate-pulse"></i> Tiempo de Planta
            </p>
            <div id="clock" class="digital text-7xl font-bold text-white tracking-tighter tabular-nums mb-4">00:00:00</div>
            
            <div id="phase-label" class="inline-block px-5 py-2 rounded-xl bg-slate-950 border border-slate-800 text-[10px] font-black uppercase tracking-widest text-slate-600">
                SISTEMA EN ESPERA
            </div>

            <div class="mt-8 grid grid-cols-2 gap-4 border-t border-slate-800 pt-6">
                <div>
                    <p class="text-[9px] text-slate-500 font-bold uppercase mb-1 text-slate-400 italic">Interior (Est. 3.5x)</p>
                    <p id="internal-temp" class="text-3xl font-black text-lime-400 tabular-nums">-- °C</p>
                </div>
                <div class="border-l border-slate-800">
                    <p class="text-[9px] text-slate-500 font-bold uppercase mb-1 text-slate-400 italic">Draft mmca</p>
                    <p id="draft-val" class="text-3xl font-black text-blue-400 tabular-nums">0.0</p>
                </div>
            </div>
        </div>

        <!-- ALERTA DE GIRO (INCHING) -->
        <div id="inching-alert" class="hidden bg-amber-500 text-black p-5 rounded-3xl flex justify-between items-center shadow-xl inching-alert">
            <div class="flex items-center gap-4">
                <i data-lucide="rotate-cw" class="animate-spin text-black"></i>
                <div class="font-black text-xs uppercase leading-tight text-black">Giro 90° Requerido<br><span class="text-[9px] opacity-70">Control de Deformación</span></div>
            </div>
            <button onclick="handleRotation()" class="bg-black text-white px-5 py-2 rounded-xl text-[10px] font-black uppercase shadow-lg active:scale-95 transition-transform">Hecho</button>
        </div>

        <!-- ENTRADA DE DATOS MANUALES -->
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-slate-900/50 border border-slate-800 p-5 rounded-[2rem]">
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block tracking-widest">Láser Casco</label>
                <input type="number" id="in-shell" class="w-full bg-transparent text-4xl font-black text-white focus:outline-none placeholder-slate-800" placeholder="00">
            </div>
            <div class="bg-slate-900/50 border border-slate-800 p-5 rounded-[2rem]">
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block tracking-widest">Draft (mmca)</label>
                <input type="number" id="in-press" step="0.1" class="w-full bg-transparent text-4xl font-black text-blue-400 focus:outline-none placeholder-slate-800" placeholder="0.0">
            </div>
        </div>

        <!-- ÁREA DE CONTROL DINÁMICA -->
        <div id="admin-controls" class="hidden grid grid-cols-4 gap-3">
            <button id="main-btn" onclick="toggleClock()" class="btn-press col-span-3 py-6 rounded-[1.5rem] bg-lime-500 text-slate-950 font-black text-xl uppercase tracking-widest flex items-center justify-center gap-3 shadow-lg shadow-lime-500/20">
                Iniciar
            </button>
            <button onclick="saveRecord()" class="btn-press bg-blue-600 text-white rounded-[1.5rem] flex items-center justify-center shadow-lg active:scale-95">
                <i data-lucide="save" size="28"></i>
            </button>
        </div>

        <div id="operator-controls" class="w-full">
            <button onclick="saveRecord()" class="btn-press w-full py-6 rounded-[1.5rem] bg-blue-600 text-white font-black text-xl uppercase tracking-widest flex items-center justify-center gap-3 shadow-lg">
                <i data-lucide="save"></i> Registrar Lectura
            </button>
        </div>

        <!-- BITÁCORA CLOUD -->
        <div class="bg-slate-900 border border-slate-800 rounded-[2rem] flex flex-col h-72 overflow-hidden shadow-2xl">
            <div class="p-4 bg-slate-900/80 border-b border-slate-800 flex justify-between items-center sticky top-0 z-10">
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2 text-slate-400">
                    <i data-lucide="cloud-sync" size="12"></i> Sincronización Real
                </h3>
                <button onclick="exportData()" class="text-[9px] font-bold text-lime-400 px-3 py-1 bg-lime-400/10 rounded-lg active:bg-lime-400/30">CSV</button>
            </div>
            <div id="log-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-950/30">
                <p class="text-center py-24 text-slate-800 italic text-[10px] font-bold uppercase tracking-widest">Conectando con Servidor...</p>
            </div>
        </div>

        <div id="reset-area" class="hidden pt-6 text-center">
            <button onclick="hardReset()" class="text-[9px] font-bold text-slate-700 hover:text-red-500 uppercase tracking-[0.5em] transition-colors">
                <i data-lucide="refresh-ccw" class="inline mr-1" size="10"></i> Reiniciar Base de Datos
            </button>
        </div>

    </main>

    <!-- FIREBASE MODULES -->
    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
      }
    }
    </script>

    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, orderBy, deleteDoc, getDocs } from "firebase/firestore";

        // CONFIGURACIÓN INICIAL
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'oruro-otm-v3';
        
        const CLAVE_ADMIN = "ORURO2026";
        const FASES = [
            { h: 40, name: "1. Secado Físico", target: 150, limit: 5, color: "text-blue-400" },
            { h: 80, name: "2. Secado Químico", target: 350, limit: 8, color: "text-amber-400" },
            { h: 120, name: "3. Vitrificación", target: 850, limit: 12, color: "text-purple-400" }
        ];

        let state = { isRunning: false, startTime: null, lastRotation: 0 };
        let elapsed = 0;
        let isAdmin = false;

        // INICIO DE SESIÓN Y SINCRONIZACIÓN
        const init = async () => {
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (u) => { if(u) startSync(); });
        };

        const startSync = () => {
            // Sincronizar Estado Maestro (Reloj e Inicio)
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'master'), (snap) => {
                if(snap.exists()) {
                    state = snap.data();
                    refreshUI();
                } else if(isAdmin) {
                    setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), state);
                }
            }, (err) => console.error("Error Sync State:", err));

            // Sincronizar Logs de Bitácora
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snap) => {
                const logs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                drawLogs(logs);
            }, (err) => console.error("Error Sync Logs:", err));
        };

        // BUCLE DE TIEMPO (CADA SEGUNDO)
        setInterval(() => {
            if(state.isRunning && state.startTime) {
                elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                
                // Lógica de alerta de Giro (900s = 15m)
                const diffRot = elapsed - (state.lastRotation || 0);
                const alertEl = document.getElementById('inching-alert');
                if(diffRot >= 900) alertEl.classList.remove('hidden');
                else alertEl.classList.add('hidden');
                
                updateVisuals();
            }
        }, 1000);

        function formatHMS(s) {
            const h = Math.floor(s/3600).toString().padStart(2,'0');
            const m = Math.floor((s%3600)/60).toString().padStart(2,'0');
            const sc = (s%60).toString().padStart(2,'0');
            return `${h}:${m}:${sc}`;
        }

        function updateVisuals() {
            document.getElementById('clock').innerText = formatHMS(elapsed);
            const hrs = elapsed / 3600;
            document.getElementById('progress-bar').style.width = Math.min((hrs/120)*100, 100) + '%';
            
            const phase = FASES.find(f => hrs < f.h) || FASES[2];
            const badge = document.getElementById('phase-label');
            if(state.isRunning) {
                badge.innerText = phase.name;
                badge.className = `inline-block px-5 py-2 rounded-xl bg-slate-950 border border-slate-800 text-[10px] font-black uppercase tracking-widest ${phase.color}`;
            }
        }

        function refreshUI() {
            const btn = document.getElementById('main-btn');
            const led = document.getElementById('led');
            const roleEl = document.getElementById('role-text');

            if(state.isRunning) {
                led.className = "w-3 h-3 rounded-full bg-lime-500 shadow-[0_0_15px_#a3e635] active-glow";
                if(btn) btn.innerText = "Pausar Curado";
                if(btn) btn.className = "btn-press col-span-3 py-6 rounded-[1.5rem] bg-slate-800 text-slate-500 font-black text-xl uppercase border border-slate-700";
            } else {
                led.className = "w-3 h-3 rounded-full bg-red-600 shadow-none";
                if(btn) btn.innerText = "Iniciar Curado";
                if(btn) btn.className = "btn-press col-span-3 py-6 rounded-[1.5rem] bg-lime-500 text-slate-950 font-black text-xl uppercase shadow-lg shadow-lime-500/20";
            }
            
            roleEl.innerText = isAdmin ? "Ingeniero (Full Control)" : "Operador (Sincronizado)";
            lucide.createIcons();
            updateVisuals();
        }

        // --- FUNCIONES ADMIN ---
        window.checkPass = () => {
            const p = document.getElementById('admin-pass').value;
            if(p === CLAVE_ADMIN) {
                isAdmin = true;
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('admin-controls').classList.remove('hidden');
                document.getElementById('operator-controls').classList.add('hidden');
                document.getElementById('reset-area').classList.remove('hidden');
                document.getElementById('admin-btn').classList.add('text-lime-400');
                refreshUI();
            } else { alert("Clave de ingeniería incorrecta"); }
        };

        window.toggleClock = async () => {
            if(!isAdmin) return;
            const nuevoStatus = !state.isRunning;
            const nuevoInicio = nuevoStatus ? Date.now() - (elapsed * 1000) : state.startTime;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), {
                isRunning: nuevoStatus,
                startTime: nuevoInicio,
                lastRotation: state.lastRotation || 0
            });
        };

        window.hardReset = async () => {
            if(!confirm("¿CONFIRMAS BORRAR TODA LA BITÁCORA Y REINICIAR EL HORNO?")) return;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), { isRunning: false, startTime: null, lastRotation: 0 });
            const snaps = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'logs'));
            snaps.forEach(async (d) => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'logs', d.id)));
            location.reload();
        };

        // --- FUNCIONES OPERATIVAS ---
        window.handleRotation = async () => {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), { ...state, lastRotation: elapsed });
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                timestamp: Date.now(),
                elapsed,
                timeLabel: formatHMS(elapsed),
                type: 'ROTACIÓN'
            });
        };

        window.saveRecord = async () => {
            const shell = document.getElementById('in-shell').value;
            const press = document.getElementById('in-press').value;
            if(!shell) return;
            
            const tShell = parseFloat(shell);
            const tInt = Math.round(tShell * 3.5); // Lógica de 3.5x

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                timestamp: Date.now(),
                elapsed,
                timeLabel: formatHMS(elapsed),
                type: 'LECTURA',
                shell: tShell,
                internal: tInt,
                press: press || '0.0'
            });

            document.getElementById('in-shell').value = '';
            document.getElementById('in-press').value = '';
        };

        window.drawLogs = (logs) => {
            const container = document.getElementById('log-list');
            if(!logs.length) { 
                container.innerHTML = '<p class="text-center py-20 text-slate-800 italic text-[10px] font-bold uppercase tracking-widest">Base de Datos Vacía</p>'; 
                return; 
            }
            
            // Actualizar Display con el último dato
            const last = logs.find(l => l.type === 'LECTURA');
            if(last) {
                document.getElementById('internal-temp').innerText = `${last.internal} °C`;
                document.getElementById('draft-val').innerText = last.press;
            }

            container.innerHTML = logs.map(l => {
                if(l.type === 'ROTACIÓN') return `<div class="p-3 bg-amber-500/10 border border-amber-500/20 rounded-xl flex justify-between items-center text-[9px] italic text-amber-500"><span>${l.timeLabel}</span><b>ROTACIÓN 90°</b></div>`;
                return `<div class="p-4 bg-slate-950 border border-slate-800 rounded-2xl flex justify-between items-center shadow-inner"><div><p class="text-[9px] text-slate-500 font-mono">${l.timeLabel}</p><p class="text-[8px] font-black text-slate-700 uppercase">Registro Láser</p></div><div class="text-right"><p class="text-2xl font-black text-white leading-none tabular-nums">${l.shell}°C</p><p class="text-[8px] text-slate-600 font-bold uppercase mt-1 tracking-tighter">Carcasa</p></div></div>`;
            }).join('');
        };

        window.exportData = () => {
            // Lógica simple de exportación CSV
            alert("Preparando descarga de bitácora...");
            // ... implementación de CSV (se omite por brevedad pero el botón está 
import React, { useState, useEffect } from 'react';
import { Play, Pause, RotateCw, Save, Trash2, History, CheckCircle, AlertCircle } from 'lucide-react';

/**
 * MONITOR MAESTRO 120H - VERCEL / CELULAR
 */

export default function App() {
  // --- ESTADOS ---
  const [isRunning, setIsRunning] = useState(false);
  const [startTime, setStartTime] = useState(null);
  const [elapsed, setElapsed] = useState(0);
  const [temp, setTemp] = useState('');
  const [press, setPress] = useState('');
  const [logs, setLogs] = useState([]);
  const [alert, setAlert] = useState(null);
  const [lastRotation, setLastRotation] = useState(0);

  // Supervisor
  const [supervisorMode, setSupervisorMode] = useState(false);
  const [passwordInput, setPasswordInput] = useState('');
  const SUPERVISOR_PASSWORD = '1234'; // Cambiable por el supervisor

  // Operadores
  const [operators, setOperators] = useState(['Punta Norte','Punta Sur']);
  const [selectedOperator, setSelectedOperator] = useState(operators[0]);

  // --- Persistencia local ---
  useEffect(() => {
    const saved = localStorage.getItem('horno_v2');
    if(saved){
      const data = JSON.parse(saved);
      setIsRunning(data.isRunning);
      setStartTime(data.startTime);
      setElapsed(data.elapsed || 0);
      setLogs(data.logs || []);
      setLastRotation(data.lastRotation || 0);
      setOperators(data.operators || ['Punta Norte','Punta Sur']);
    }
  }, []);

  useEffect(() => {
    localStorage.setItem('horno_v2', JSON.stringify({ isRunning, startTime, elapsed, logs, lastRotation, operators }));
  }, [isRunning, startTime, elapsed, logs, lastRotation, operators]);

  // --- Cronómetro ---
  useEffect(() => {
    let interval = null;
    if(isRunning && startTime){
      interval = setInterval(() => {
        setElapsed(Math.floor((Date.now() - startTime)/1000));
      },1000);
    }
    return () => clearInterval(interval);
  },[isRunning, startTime]);

  // --- Formateo de tiempo ---
  const formatTime = (s) => {
    const h = Math.floor(s/3600).toString().padStart(2,'0');
    const m = Math.floor((s%3600)/60).toString().padStart(2,'0');
    const sc = (s%60).toString().padStart(2,'0');
    return `${h}:${m}:${sc}`;
  };

  // --- Fases y límites ---
  const phase = (() => {
    const h = elapsed/3600;
    if(h<40) return { n:"1. DESHUMIDIFICACIÓN", l:5, c:"text-blue-400" };
    if(h<80) return { n:"2. QUÍMICA", l:8, c:"text-yellow-400" };
    if(h<120) return { n:"3. VITRIFICACIÓN", l:12, c:"text-red-400" };
    return { n:"FIN", l:0, c:"text-purple-400" };
  })();

  const rotationNeeded = isRunning && (elapsed - lastRotation >= 900);

  const handleRotation = () => {
    setLastRotation(elapsed);
    setLogs([{id:Date.now(), s:elapsed, t:formatTime(elapsed), type:'ROTACIÓN', operador:selectedOperator}, ...logs]);
  };

  const saveEntry = () => {
    if(!temp || !press) return;
    const t = parseFloat(temp);
    const p = parseFloat(press);
    let warning = null;

    if(logs.length > 0){
      const prev = logs.find(l => !l.type);
      if(prev){
        const rate = (t - prev.temp_casco)/((elapsed - prev.s)/3600);
        if(phase.l>0 && rate>phase.l) warning = `RAMPA ALTA: ${rate.toFixed(1)}°C/h`;
      }
    }

    setLogs([{id:Date.now(), s:elapsed, t:formatTime(elapsed), operador:selectedOperator, temp_casco:t, temp_interna:t*3.5, press:p, warning}, ...logs]);
    setTemp(''); setPress('');
    if(warning){ setAlert(warning); setTimeout(()=>setAlert(null),5000);}
  };

  const exportData = () => {
    let csv = "Tiempo,Operador,Tipo,Temp Casco,Temp Interna,Presion,Alerta\n";
    [...logs].reverse().forEach(l => csv += `${l.t},${l.operador},${l.type||'DATO'},${l.temp_casco||''},${l.temp_interna||''},${l.press||''},${l.warning||''}\n`);
    const blob = new Blob([csv], { type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `curado_oruro_verano.csv`;
    a.click();
  };

  const toggleSupervisor = () => {
    if(passwordInput === SUPERVISOR_PASSWORD) setSupervisorMode(!supervisorMode);
    else alert('Clave incorrecta');
    setPasswordInput('');
  };

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 p-4 font-sans flex flex-col items-center">
      <div className="w-full max-w-xl space-y-4">

        {/* HEADER */}
        <header className="flex justify-between items-center border-b border-slate-800 pb-3">
          <div>
            <h1 className="text-xl font-black text-lime-400 italic">ORURO <span className="text-white">THERMAL MASTER</span></h1>
            <p className="text-[9px] font-bold text-slate-500 tracking-[0.3em] uppercase">Control Verano 2026 • 3,700 msnm</p>
          </div>
          <div className={`w-3 h-3 rounded-full ${isRunning?'bg-lime-500 shadow-[0_0_10px_#84cc16] animate-pulse':'bg-red-600'}`}></div>
        </header>

        {/* Supervisor Login */}
        {!supervisorMode && (
          <div className="flex gap-2">
            <input type="password" placeholder="Clave Supervisor" value={passwordInput} onChange={e=>setPasswordInput(e.target.value)} className="flex-1 p-2 rounded-lg bg-slate-800 text-white" />
            <button onClick={toggleSupervisor} className="bg-lime-500 px-3 rounded-lg font-bold">Entrar</button>
          </div>
        )}

        {/* Supervisor controls */}
        {supervisorMode && (
          <div className="bg-slate-900 p-3 rounded-2xl space-y-2">
            <h3 className="text-[10px] text-slate-400 font-bold">Supervisor Mode</h3>
            <div className="flex gap-2">
              <button onClick={()=>{if(confirm('Reiniciar horno?')){setIsRunning(false);setElapsed(0);setLogs([]);setLastRotation(0);}}} className="bg-red-600 px-2 py-1 rounded font-bold text-xs">Reset Horno</button>
              <button onClick={()=>setSupervisorMode(false)} className="bg-slate-700 px-2 py-1 rounded font-bold text-xs">Cerrar Supervisor</button>
            </div>
            {/* Edit operators */}
            <div className="mt-2">
              <h4 className="text-[10px] font-bold text-slate-400">Operadores</h4>
              <div className="flex gap-2 mt-1 flex-wrap">
                {operators.map((op,i)=>
                  <div key={i} className="bg-slate-700 px-2 py-1 rounded flex items-center gap-1 text-xs">
                    <span>{op}</span>
                    <button onClick={()=>setOperators(operators.filter((_,idx)=>idx!==i))} className="text-red-400 font-bold">x</button>
                  </div>
                )}
                <button onClick={()=>{const n=prompt('Nombre operador'); if(n)setOperators([...operators,n]);}} className="bg-lime-500 px-2 py-1 rounded text-xs font-bold">+ Agregar</button>
              </div>
            </div>
          </div>
        )}

        {/* Timer y fase */}
        <div className="bg-black border-2 border-slate-800 rounded-[2.5rem] p-8 text-center shadow-2xl relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-1 bg-slate-900">
            <div className="h-full bg-lime-500 transition-all duration-1000" style={{width:`${Math.min((elapsed/(120*3600))*100,100)}%`}}></div>
          </div>
          <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Reloj de Curado</p>
          <div className="text-7xl font-mono font-black text-white leading-none mb-4 tracking-tighter tabular-nums">{formatTime(elapsed)}</div>
          <div className={`inline-flex items-center gap-2 px-4 py-1.5 rounded-full border text-[10px] font-bold uppercase tracking-widest ${phase.c} bg-slate-900/50 border-slate-800`}>
            {phase.n}
          </div>
        </div>

        {/* Alerta de virado */}
        {rotationNeeded && (
          <div className="bg-amber-500 text-black p-4 rounded-2xl flex justify-between items-center animate-bounce shadow-lg shadow-amber-500/20">
            <div className="flex items-center gap-3">
              <RotateCw className="animate-spin" size={24} />
              <p className="font-black text-sm uppercase">¡Toca virar el horno! (90°)</p>
            </div>
            <button onClick={handleRotation} className="bg-black text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase">Marcar Giro</button>
          </div>
        )}

        {/* Entrada datos */}
        <div className="grid grid-cols-2 gap-3">
          <div className="bg-slate-900 border border-slate-800 p-5 rounded-3xl text-center">
            <label className="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Temp Panel (°C)</label>
            <input type="number" value={temp} onChange={e=>setTemp(e.target.value)} className="w-full bg-transparent text-4xl font-black text-white text-center focus:outline-none placeholder-slate-800" placeholder="000" />
          </div>
          <div className="bg-slate-900 border border-slate-800 p-5 rounded-3xl text-center">
            <label className="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Draft (mmca)</label>
            <input type="number" value={press} onChange={e=>setPress(e.target.value)} className="w-full bg-transparent text-4xl font-black text-cyan-400 text-center focus:outline-none placeholder-slate-800" placeholder="0.0" />
          </div>
        </div>

        {/* Selección de operador */}
        <div className="mt-2">
          <label className="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Operador</label>
          <select value={selectedOperator} onChange={e=>setSelectedOperator(e.target.value)} className="w-full p-2 rounded-lg bg-slate-800 text-white">
            {operators.map((op,i)=><option key={i} value={op}>{op}</option>)}
          </select>
        </div>

        {/* Controles */}
        <div className="grid grid-cols-4 gap-3 mt-3">
          <button onClick={()=>{if(!isRunning) setStartTime(Date.now()-(elapsed*1000)); setIsRunning(!isRunning);}} className={`col-span-3 py-5 rounded-2xl font-black text-lg flex items-center justify-center gap-3 ${isRunning?'bg-slate-800 text-slate-400 border border-slate-700':'bg-lime-500 text-slate-950 shadow-lg shadow-lime-500/20'}`}>
            {isRunning ? <><Pause size={24}/> PAUSAR</> : <><Play size={24}/> INICIAR CURADO</>}
          </button>
          <button onClick={saveEntry} disabled={!isRunning} className="bg-blue-600 text-white rounded-2xl flex items-center justify-center active:scale-95 disabled:opacity-20 transition-all"><Save size={28}/></button>
        </div>

        {/* Alerta Rampa */}
        {alert && (
          <div className="bg-red-600/20 border-2 border-red-500 p-4 rounded-2xl flex items-center gap-4 animate-pulse">
            <AlertCircle className="text-red-500" size={32} />
            <div className="text-red-200">
              <p className="text-[10px] font-black uppercase">¡Rampa Excesiva!</p>
              <p className="text-xs font-bold">{alert}</p>
            </div>
          </div>
        )}

        {/* Bitácora */}
        <div className="bg-slate-900 border border-slate-800 rounded-[2rem] overflow-hidden flex flex-col h-64 shadow-xl mt-2">
          <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/80 sticky top-0 z-10">
            <h3 className="text-[10px] font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2"><History size={14}/> Bitácora Operativa</h3>
            <button onClick={exportData} className="text-[9px] font-bold text-lime-400 bg-lime-400/10 px-3 py-1 rounded-lg border border-lime-400/20">EXCEL</button>
          </div>
          <div className="overflow-y-auto p-2 space-y-2">
            {logs.map(log=>(
              <div key={log.id} className={`p-4 rounded-2xl border ${log.type?'bg-amber-500/5 border-amber-500/20 italic':log.warning?'bg-red-900/20 border-red-500/30':'bg-slate-950 border-slate-800'} flex justify-between items-center`}>
                <div>
                  <div className="text-[10px] text-slate-500 font-mono">{log.t}</div>
                  {log.type && <div className="text-[9px] font-bold text-amber-500 mt-1 uppercase">Giro Mecánico 90°</div>}
                  {log.warning && <div className="text-[9px] font-bold text-red-500 uppercase mt-1">⚠️ RAMPA ALTA</div>}
                </div>
                {!log.type && (
                  <div className="text-right">
                    <div className="text-2xl font-black text-white leading-none">{log.temp_casco}°C</div>
                    <div className="text-[9px] font-bold text-slate-600 mt-1 uppercase">Draft: {log.press}</div>
                  </div>
                )}
                {log.type && <CheckCircle size={16} className="text-amber-500" />}
              </div>
            ))}
          </div>
        </div>

      </div>
    </div>
  );
}

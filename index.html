<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Credenciales Reales de Oruro
    const firebaseConfig = {
        apiKey:            "AIzaSyCzUxfhj2wGFXDXHrmqi7sYkCUOPMFanzQ",
        authDomain:        "otm-120h-oruro.firebaseapp.com",
        projectId:         "otm-120h-oruro",
        storageBucket:     "otm-120h-oruro.firebasestorage.app",
        messagingSenderId: "442199177770",
        appId:             "1:442199177770:web:21770802ebef01a34c2153"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const aid = 'otm-120h-oruro-final';

    // Funciones de Diagnóstico
    function setNetStatus(isOnline) {
        const el = document.getElementById('net-status');
        el.innerText = isOnline ? "● CONECTADO" : "● OFFLINE";
        el.className = isOnline ? "text-[8px] font-bold text-lime-500 uppercase mt-1" : "text-[8px] font-bold text-red-500 uppercase mt-1";
    }

    function showDiag(msg) {
        document.getElementById('loader-icon').classList.add('hidden');
        document.getElementById('loading-msg').innerText = msg;
        document.getElementById('error-ui').classList.remove('hidden');
    }

    // Inicio Secuencial (Boot)
    async function boot() {
        try {
            await signInAnonymously(auth);
            setNetStatus(true);
            document.getElementById('loading-screen').classList.add('hidden');
            startSync();
        } catch (err) {
            setNetStatus(false);
            showDiag('Error de Autenticación: ' + err.code);
        }
    }

    function startSync() {
        onSnapshot(doc(db, 'artifacts', aid, 'public', 'data', 'master'), (snap) => {
            if(snap.exists()) {
                window.st = snap.data();
                updateUI();
            } else {
                setDoc(doc(db, 'artifacts', aid, 'public', 'data', 'master'), { 
                    running: false, 
                    startTS: null, 
                    lastRotTS: null 
                });
            }
        }, (err) => {
            showDiag('Error de Sincronización: ' + err.code);
        });
    }

    // Nuevo PIN numérico sugerido
    window.f_pin = () => {
        const pinInput = document.getElementById('a-pin').value;
        if(pinInput === "1407") {
            document.getElementById('a-pin').value = '';
            f_nav('v-adm');
        } else { 
            alert("PIN INCORRECTO"); 
            document.getElementById('a-pin').value = ''; 
        }
    };

    boot();
</script>

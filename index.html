<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OTM 120H - Oruro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Inter:wght@400;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #020617; color: white; -webkit-tap-highlight-color: transparent; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .view { display: none; min-height: 100vh; width: 100%; }
        .view.active { display: flex; flex-direction: column; }
    </style>
</head>
<body>

    <!-- VISTA 1: MONITOR (PÃšBLICO) -->
    <div id="view-monitor" class="view active p-4">
        <header class="flex justify-between items-center bg-slate-900 p-5 rounded-3xl border border-slate-800 mb-6">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter">OTM <span class="text-lime-400">120H</span></h1>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Planta Oruro - Modo Lectura</p>
            </div>
            <div id="status-led" class="w-4 h-4 rounded-full bg-red-600"></div>
        </header>

        <main class="flex-1 space-y-4">
            <!-- RELOJ -->
            <div class="bg-slate-900/50 border border-slate-800 rounded-[3rem] p-10 text-center shadow-2xl">
                <div id="clock" class="mono text-6xl font-bold mb-2 tracking-tighter">00:00:00</div>
                <div id="phase" class="text-[10px] font-black uppercase text-slate-500 tracking-[0.3em]">Sistema en Espera</div>
            </div>

            <!-- DATOS -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-900 p-6 rounded-[2rem] border border-slate-800 text-center">
                    <p class="text-[9px] font-bold text-slate-500 uppercase mb-1">Temp Int.</p>
                    <p id="val-temp" class="text-3xl font-black text-lime-400">--Â°C</p>
                </div>
                <div class="bg-slate-900 p-6 rounded-[2rem] border border-slate-800 text-center">
                    <p class="text-[9px] font-bold text-slate-500 uppercase mb-1">PresiÃ³n</p>
                    <p id="val-press" class="text-3xl font-black text-sky-400">0.0</p>
                </div>
            </div>

            <!-- LISTA DE REGISTROS -->
            <div id="log-container" class="bg-slate-950 rounded-[2rem] p-4 h-64 overflow-y-auto border border-slate-900 text-xs">
                <p class="text-slate-700 text-center mt-20 uppercase font-bold tracking-widest">Cargando bitÃ¡cora...</p>
            </div>

            <!-- BOTÃ“N DE ACCESO (SIMPLE Y GRANDE) -->
            <button id="btn-to-login" class="w-full py-6 bg-slate-800 text-slate-400 font-black rounded-3xl uppercase tracking-widest text-sm border-2 border-slate-700 active:bg-slate-700 transition-all mt-4">
                ðŸ”“ Acceso de IngenierÃ­a
            </button>
        </main>
    </div>

    <!-- VISTA 2: LOGIN (PIN) -->
    <div id="view-login" class="view p-6 items-center justify-center bg-black">
        <div class="w-full max-w-xs text-center">
            <h2 class="text-3xl font-black mb-8 italic uppercase tracking-tighter">Ingresar PIN</h2>
            <input type="password" id="input-pin" class="w-full bg-slate-900 border-2 border-slate-700 p-6 rounded-2xl text-center text-5xl mb-8 text-lime-400 font-bold outline-none" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric">
            
            <div class="grid grid-cols-1 gap-4">
                <button id="btn-login-submit" class="w-full py-6 bg-lime-500 text-black font-black rounded-2xl uppercase text-lg shadow-xl shadow-lime-500/20 active:scale-95 transition-transform">Verificar</button>
                <button id="btn-login-cancel" class="w-full py-3 text-slate-500 font-bold uppercase text-xs tracking-widest">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- VISTA 3: PANEL DE CONTROL (ADMIN) -->
    <div id="view-admin" class="view p-4 bg-slate-950">
        <header class="flex justify-between items-center p-5 mb-4 border-b border-slate-800">
            <h2 class="text-lime-400 font-black italic uppercase tracking-widest">Panel de Control</h2>
            <button id="btn-logout" class="text-[10px] bg-red-900/30 text-red-500 px-4 py-2 rounded-full font-bold uppercase">Cerrar</button>
        </header>

        <div class="space-y-6">
            <!-- BOTÃ“N MAESTRO -->
            <button id="btn-master-toggle" class="w-full py-10 rounded-[3rem] bg-lime-500 text-black font-black text-3xl uppercase shadow-2xl active:scale-95 transition-all">
                Iniciar
            </button>

            <!-- FORMULARIO -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-900 p-6 rounded-3xl border border-slate-700">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Temp Casco</label>
                    <input type="number" id="in-shell" class="w-full bg-transparent text-4xl font-black text-white outline-none" placeholder="00" inputmode="decimal">
                </div>
                <div class="bg-slate-900 p-6 rounded-3xl border border-slate-700">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-2">Draft mmca</label>
                    <input type="number" id="in-press" step="0.1" class="w-full bg-transparent text-4xl font-black text-sky-400 outline-none" placeholder="0.0" inputmode="decimal">
                </div>
            </div>

            <button id="btn-save-data" class="w-full py-6 bg-blue-600 text-white font-black rounded-3xl uppercase shadow-lg active:scale-95 transition-all">
                Guardar Registro
            </button>

            <button id="btn-hard-reset" class="w-full py-2 text-red-900 font-bold uppercase text-[10px] mt-10 tracking-widest">
                Reiniciar Servidor (Peligro)
            </button>
        </div>
    </div>

    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
      }
    }
    </script>

    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, orderBy, deleteDoc, getDocs } from "firebase/firestore";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'otm-oruro-final-v1';

        const PIN_SECRET = "ORURO2026";
        let state = { isRunning: false, startTS: null };
        let user = null;

        // --- NAVEGACIÃ“N ---
        const switchView = (viewId) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            window.scrollTo(0, 0);
        };

        // Eventos de NavegaciÃ³n
        document.getElementById('btn-to-login').onclick = () => switchView('view-login');
        document.getElementById('btn-login-cancel').onclick = () => switchView('view-monitor');
        document.getElementById('btn-logout').onclick = () => switchView('view-monitor');

        document.getElementById('btn-login-submit').onclick = () => {
            const val = document.getElementById('input-pin').value;
            if(val === PIN_SECRET) {
                switchView('view-admin');
                document.getElementById('input-pin').value = '';
            } else {
                alert("PIN INCORRECTO");
                document.getElementById('input-pin').value = '';
            }
        };

        // --- CORE LÃ“GICA ---
        const init = async () => {
            await signInAnonymously(auth);
            onAuthStateChanged(auth, u => {
                if(u) {
                    user = u;
                    sync();
                }
            });
        };

        const sync = () => {
            // Estado Maestro
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'master'), (snap) => {
                if(snap.exists()) {
                    state = snap.data();
                    updateUI();
                } else {
                    setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), { isRunning: false, startTS: null });
                }
            }, (err) => console.error("Error Sync Master:", err));

            // Logs
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snap) => {
                const logs = snap.docs.map(d => d.data());
                renderLogs(logs);
            });
        };

        function updateUI() {
            const led = document.getElementById('status-led');
            const phase = document.getElementById('phase');
            const btn = document.getElementById('btn-master-toggle');

            if(state.isRunning) {
                led.className = "w-4 h-4 rounded-full bg-lime-500 shadow-[0_0_10px_#a3e635]";
                phase.innerText = "Hornada en Curso";
                phase.className = "text-[10px] font-black uppercase text-lime-400 tracking-[0.3em]";
                btn.innerText = "PAUSAR";
                btn.className = "w-full py-10 rounded-[3rem] bg-slate-800 text-slate-500 font-black text-3xl uppercase";
            } else {
                led.className = "w-4 h-4 rounded-full bg-red-600";
                phase.innerText = "Sistema en Espera";
                phase.className = "text-[10px] font-black uppercase text-slate-500 tracking-[0.3em]";
                btn.innerText = "INICIAR";
                btn.className = "w-full py-10 rounded-[3rem] bg-lime-500 text-black font-black text-3xl uppercase";
            }
        }

        // Reloj
        setInterval(() => {
            if(state.isRunning && state.startTS) {
                const elapsedS = Math.floor((Date.now() - state.startTS) / 1000);
                const h = Math.floor(elapsedS / 3600).toString().padStart(2,'0');
                const m = Math.floor((elapsedS % 3600) / 60).toString().padStart(2,'0');
                const s = (elapsedS % 60).toString().padStart(2,'0');
                document.getElementById('clock').innerText = `${h}:${m}:${s}`;
            } else {
                document.getElementById('clock').innerText = "00:00:00";
            }
        }, 1000);

        // --- ACCIONES ADMIN ---
        document.getElementById('btn-master-toggle').onclick = async () => {
            const newState = !state.isRunning;
            let newTS = state.startTS;
            if(newState && !state.startTS) newTS = Date.now();
            if(!newState) newTS = state.startTS; // Mantiene el tiempo si pausa, o podrÃ­as resetearlo

            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), {
                isRunning: newState,
                startTS: newTS
            });
        };

        document.getElementById('btn-save-data').onclick = async () => {
            const shell = document.getElementById('in-shell').value;
            const press = document.getElementById('in-press').value;
            if(!shell) return alert("Ingrese Temp Casco");

            const tShell = parseFloat(shell);
            const tInt = Math.round(tShell * 3.5);
            const elapsedS = state.startTS ? Math.floor((Date.now() - state.startTS) / 1000) : 0;

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                timestamp: Date.now(),
                elapsed: elapsedS,
                shell: tShell,
                internal: tInt,
                press: press || '0.0'
            });

            document.getElementById('in-shell').value = '';
            document.getElementById('in-press').value = '';
            alert("REGISTRO GUARDADO");
        };

        function renderLogs(logs) {
            const container = document.getElementById('log-container');
            if(!logs.length) {
                container.innerHTML = '<p class="text-slate-800 text-center mt-20 uppercase font-bold tracking-widest italic">Sin registros</p>';
                return;
            }

            // Actualizar valores principales con el Ãºltimo log
            const last = logs[0];
            document.getElementById('val-temp').innerText = `${last.internal}Â°C`;
            document.getElementById('val-press').innerText = last.press;

            container.innerHTML = logs.map(l => {
                const hrs = Math.floor(l.elapsed / 3600);
                return `
                <div class="p-4 bg-slate-900 rounded-2xl mb-2 flex justify-between items-center border border-slate-800">
                    <div>
                        <span class="text-[9px] text-slate-500 font-mono">T+${hrs}h</span>
                        <div class="text-sky-400 font-black">${l.press} mmca</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-black text-white">${l.shell}Â°C</div>
                        <div class="text-[8px] text-slate-500 uppercase font-bold">Carcasa</div>
                    </div>
                </div>`;
            }).join('');
        }

        document.getElementById('btn-hard-reset').onclick = async () => {
            if(!confirm("BORRAR TODO?")) return;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), { isRunning: false, startTS: null });
            const snaps = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'logs'));
            for(const d of snaps.docs) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'logs', d.id));
            location.reload();
        };

        init();
    </script>
</body>
</html>
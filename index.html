<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>OTM 120H Master</title>
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/240/fire-element.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/240/fire-element.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Inter:wght@400;700;900&display=swap');
        :root { 
            --bg: #020617; 
            --panel: #0f172a;
            --lime: #a3e635; 
            --blue: #38bdf8; 
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            color: #f1f5f9; 
            touch-action: manipulation;
            overscroll-behavior: none;
        }
        .digital { font-family: 'JetBrains Mono', monospace; }
        .glass { 
            background: rgba(15, 23, 42, 0.9); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(51, 65, 85, 0.5); 
        }
        /* Animación para que encuentres el botón fácilmente */
        @keyframes pulse-admin {
            0% { box-shadow: 0 0 0 0px rgba(163, 230, 53, 0.4); }
            100% { box-shadow: 0 0 0 15px rgba(163, 230, 53, 0); }
        }
        .admin-pulse { animation: pulse-admin 2s infinite; }
        
        .btn-press:active { transform: scale(0.96); opacity: 0.9; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 pb-12">

    <!-- MODAL DE ACCESO ADMIN -->
    <div id="login-modal" class="fixed inset-0 bg-black/95 z-[100] hidden flex items-center justify-center p-6 backdrop-blur-md">
        <div class="glass p-8 rounded-[2.5rem] w-full max-w-xs text-center border-lime-500/30 shadow-2xl">
            <h2 class="text-xl font-black mb-6 uppercase italic tracking-tighter text-white">Ingeniería Oruro</h2>
            <p class="text-[10px] text-slate-500 mb-4 font-bold">INTRODUZCA PIN MAESTRO</p>
            <input type="password" id="admin-pass" class="w-full bg-slate-900 border border-slate-700 p-4 rounded-2xl text-center text-3xl mb-6 focus:border-lime-500 outline-none text-lime-400 font-black" placeholder="••••" inputmode="text">
            <div class="flex gap-3">
                <button onclick="closeLogin()" class="flex-1 py-4 text-[10px] font-bold text-slate-500 uppercase">Cerrar</button>
                <button onclick="checkPass()" class="flex-1 py-4 bg-lime-500 text-black font-black rounded-2xl uppercase text-[10px]">Validar</button>
            </div>
        </div>
    </div>

    <!-- CABECERA RESALTADA -->
    <header class="w-full max-w-lg flex justify-between items-center mb-6 bg-slate-900/80 p-4 rounded-3xl border border-slate-800 shadow-xl">
        <div class="flex items-center gap-3">
            <div id="led" class="w-3 h-3 rounded-full bg-red-600 transition-colors duration-500"></div>
            <div>
                <h1 class="text-lg font-black italic tracking-tighter uppercase text-white">OTM <span class="text-lime-400">120H</span></h1>
                <p id="role-text" class="text-[8px] font-bold text-slate-500 uppercase tracking-[0.2em]">Modo Lectura</p>
            </div>
        </div>
        
        <!-- BOTÓN DE ADMIN MUCHO MÁS GRANDE Y MARCADO -->
        <button id="admin-btn-trigger" onclick="openLogin()" class="admin-pulse bg-slate-800 flex items-center gap-2 px-4 py-3 rounded-2xl border-2 border-lime-500/50 hover:bg-slate-700 transition-all active:scale-90">
            <span class="text-[10px] font-black text-lime-400 uppercase tracking-widest">Acceso</span>
            <i data-lucide="shield-check" class="text-lime-400" size="20"></i>
        </button>
    </header>

    <main class="w-full max-w-lg space-y-4">
        
        <!-- DASHBOARD CENTRAL -->
        <div class="glass rounded-[2.5rem] p-8 text-center relative overflow-hidden shadow-2xl">
            <div class="absolute top-0 left-0 w-full h-1.5 bg-slate-950">
                <div id="progress-bar" class="h-full bg-lime-500 transition-all duration-1000" style="width: 0%"></div>
            </div>
            
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-2">Tiempo de Planta</p>
            <div id="clock" class="digital text-7xl font-bold text-white tracking-tighter tabular-nums mb-4">00:00:00</div>
            
            <div id="phase-label" class="inline-block px-5 py-2 rounded-xl bg-slate-950 border border-slate-800 text-[10px] font-black uppercase tracking-widest text-slate-600">
                SISTEMA EN ESPERA
            </div>

            <div class="mt-8 grid grid-cols-2 gap-4 border-t border-slate-800 pt-6">
                <div>
                    <p class="text-[9px] text-slate-500 font-bold uppercase mb-1 italic">Interna (3.5x)</p>
                    <p id="internal-temp" class="text-3xl font-black text-lime-400 tabular-nums">-- °C</p>
                </div>
                <div class="border-l border-slate-800">
                    <p class="text-[9px] text-slate-500 font-bold uppercase mb-1 italic">Draft mmca</p>
                    <p id="draft-val" class="text-3xl font-black text-blue-400 tabular-nums">0.0</p>
                </div>
            </div>
        </div>

        <!-- ALERTA DE GIRO -->
        <div id="inching-alert" class="hidden bg-amber-500 text-black p-5 rounded-3xl flex justify-between items-center shadow-xl animate-bounce">
            <div class="flex items-center gap-4">
                <i data-lucide="rotate-cw" class="animate-spin text-black"></i>
                <div class="font-black text-xs uppercase leading-tight">Giro 90° Requerido<br><span class="text-[9px] opacity-70">Control de Banana</span></div>
            </div>
            <button onclick="handleRotation()" class="bg-black text-white px-5 py-2 rounded-xl text-[10px] font-black uppercase">Hecho</button>
        </div>

        <!-- ENTRADA DE DATOS -->
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-slate-900/50 border border-slate-800 p-5 rounded-[2rem]">
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Láser Casco</label>
                <input type="number" id="in-shell" class="w-full bg-transparent text-4xl font-black text-white focus:outline-none" placeholder="00" inputmode="decimal">
            </div>
            <div class="bg-slate-900/50 border border-slate-800 p-5 rounded-[2rem]">
                <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Draft</label>
                <input type="number" id="in-press" step="0.1" class="w-full bg-transparent text-4xl font-black text-blue-400 focus:outline-none" placeholder="0.0" inputmode="decimal">
            </div>
        </div>

        <!-- CONTROLES DINÁMICOS -->
        <div id="admin-controls" class="hidden grid grid-cols-4 gap-3">
            <button id="main-btn" onclick="toggleClock()" class="btn-press col-span-3 py-6 rounded-[1.5rem] bg-lime-500 text-slate-950 font-black text-xl uppercase tracking-widest shadow-lg">
                Iniciar
            </button>
            <button onclick="saveRecord()" class="btn-press bg-blue-600 text-white rounded-[1.5rem] flex items-center justify-center">
                <i data-lucide="save" size="28"></i>
            </button>
        </div>

        <div id="operator-controls" class="w-full">
            <button onclick="saveRecord()" class="btn-press w-full py-6 rounded-[1.5rem] bg-blue-600 text-white font-black text-xl uppercase tracking-widest shadow-lg">
                Registrar Lectura
            </button>
        </div>

        <!-- BITÁCORA -->
        <div class="bg-slate-900 border border-slate-800 rounded-[2rem] flex flex-col h-64 overflow-hidden shadow-2xl">
            <div class="p-4 bg-slate-900/80 border-b border-slate-800 flex justify-between items-center">
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Bitácora Cloud</h3>
                <button onclick="exportData()" class="text-[9px] font-bold text-lime-400 px-3 py-1 bg-lime-400/10 rounded-lg">Exportar</button>
            </div>
            <div id="log-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-950/30">
                <p class="text-center py-20 text-slate-800 text-[10px] font-bold uppercase italic">Sincronizando...</p>
            </div>
        </div>

        <div id="reset-area" class="hidden pt-4 text-center">
            <button onclick="hardReset()" class="text-[9px] font-bold text-red-900 uppercase tracking-widest">Reiniciar Todo el Sistema</button>
        </div>

    </main>

    <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
      }
    }
    </script>

    <script type="module">
        import { initializeApp } from "firebase/app";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, orderBy, deleteDoc, getDocs } from "firebase/firestore";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'otm-oruro-final';
        
        const PIN_ADMIN = "ORURO2026";
        let state = { isRunning: false, startTime: null, lastRotation: 0 };
        let elapsed = 0;
        let isAdmin = false;

        const init = async () => {
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (u) => { if(u) syncData(); });
        };

        const syncData = () => {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'master'), (snap) => {
                if(snap.exists()) {
                    state = snap.data();
                    refreshUI();
                } else if(isAdmin) {
                    setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), state);
                }
            });

            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snap) => {
                const logs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                updateLogList(logs);
            });
        };

        setInterval(() => {
            if(state.isRunning && state.startTime) {
                elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                
                const diffRot = elapsed - (state.lastRotation || 0);
                if(diffRot >= 900) document.getElementById('inching-alert').classList.remove('hidden');
                else document.getElementById('inching-alert').classList.add('hidden');
                
                updateClockView();
            }
        }, 1000);

        function updateClockView() {
            const h = Math.floor(elapsed/3600).toString().padStart(2,'0');
            const m = Math.floor((elapsed%3600)/60).toString().padStart(2,'0');
            const s = (elapsed%60).toString().padStart(2,'0');
            document.getElementById('clock').innerText = `${h}:${m}:${s}`;
            document.getElementById('progress-bar').style.width = Math.min((elapsed/432000)*100, 100) + '%';
        }

        function refreshUI() {
            const btn = document.getElementById('main-btn');
            const led = document.getElementById('led');
            const roleEl = document.getElementById('role-text');

            if(state.isRunning) {
                led.className = "w-3 h-3 rounded-full bg-lime-500 shadow-[0_0_10px_#a3e635]";
                if(btn) btn.innerText = "Pausar Curado";
            } else {
                led.className = "w-3 h-3 rounded-full bg-red-600";
                if(btn) btn.innerText = "Iniciar Curado";
            }
            
            roleEl.innerText = isAdmin ? "Ingeniero (Full Control)" : "Operador (Sincronizado)";
            lucide.createIcons();
            updateClockView();
        }

        window.openLogin = () => document.getElementById('login-modal').classList.remove('hidden');
        window.closeLogin = () => document.getElementById('login-modal').classList.add('hidden');

        window.checkPass = () => {
            const p = document.getElementById('admin-pass').value;
            if(p === PIN_ADMIN) {
                isAdmin = true;
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('admin-controls').classList.remove('hidden');
                document.getElementById('operator-controls').classList.add('hidden');
                document.getElementById('reset-area').classList.remove('hidden');
                document.getElementById('admin-btn-trigger').classList.remove('admin-pulse');
                document.getElementById('admin-btn-trigger').classList.add('bg-lime-500', 'border-white');
                document.querySelector('#admin-btn-trigger span').innerText = "ADMIN";
                document.querySelector('#admin-btn-trigger span').classList.replace('text-lime-400', 'text-black');
                document.querySelector('#admin-btn-trigger i').classList.replace('text-lime-400', 'text-black');
                refreshUI();
            } else { alert("PIN Incorrecto"); }
        };

        window.toggleClock = async () => {
            if(!isAdmin) return;
            const nuevoStatus = !state.isRunning;
            const nuevoInicio = nuevoStatus ? Date.now() - (elapsed * 1000) : state.startTime;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), {
                isRunning: nuevoStatus,
                startTime: nuevoInicio,
                lastRotation: state.lastRotation || 0
            });
        };

        window.saveRecord = async () => {
            const shell = document.getElementById('in-shell').value;
            const press = document.getElementById('in-press').value;
            if(!shell) return;
            
            const tShell = parseFloat(shell);
            const tInt = Math.round(tShell * 3.5);

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                timestamp: Date.now(),
                elapsed,
                shell: tShell,
                internal: tInt,
                press: press || '0.0'
            });

            document.getElementById('in-shell').value = '';
            document.getElementById('in-press').value = '';
        };

        window.handleRotation = async () => {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), { ...state, lastRotation: elapsed });
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), {
                timestamp: Date.now(),
                elapsed,
                type: 'ROTACIÓN'
            });
        };

        function updateLogList(logs) {
            const container = document.getElementById('log-list');
            if(!logs.length) { container.innerHTML = '<p class="text-center py-20 text-slate-800 text-[10px] font-bold uppercase">Sin registros</p>'; return; }
            
            const last = logs.find(l => !l.type);
            if(last) {
                document.getElementById('internal-temp').innerText = `${last.internal} °C`;
                document.getElementById('draft-val').innerText = last.press;
            }

            container.innerHTML = logs.map(l => {
                if(l.type) return `<div class="p-2 bg-amber-500/10 border border-amber-500/20 rounded-xl text-[8px] text-amber-500 font-bold uppercase text-center italic">Giro 90° Realizado</div>`;
                return `<div class="p-3 bg-slate-950 border border-slate-800 rounded-xl flex justify-between items-center"><div class="text-[8px] text-slate-500 font-mono italic">Lectura</div><div class="text-right font-black"><span class="text-white text-lg">${l.shell}°C</span> <span class="text-lime-500 text-xs ml-2">${l.internal}°C Int</span></div></div>`;
            }).join('');
        }

        window.hardReset = async () => {
            if(!confirm("BORRAR TODO?")) return;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), { isRunning: false, startTime: null, lastRotation: 0 });
            const snaps = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'logs'));
            snaps.forEach(async (d) => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'logs', d.id)));
            location.reload();
        };

        init();
    </script>
</body>
</html>
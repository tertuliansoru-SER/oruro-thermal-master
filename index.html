import React, { useState, useEffect, useRef } from 'react';
import { LucideIcon, Play, Pause, Lock, RotateCw, ClipboardList, Database, Download, X, CheckCircle, AlertTriangle, UserCircle } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, orderBy, getDocs, deleteDoc } from 'firebase/firestore';

// --- CONFIGURACIÓN FIREBASE ---
const firebaseConfig = JSON.parse(__firebase_config);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'otm-120h-v5';
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

export default function App() {
  // Estados de Navegación y Auth
  const [view, setView] = useState('monitor');
  const [user, setUser] = useState(null);
  const [pin, setPin] = useState('');
  
  // Estados de la Hornada
  const [masterState, setMasterState] = useState({ running: false, startTS: null, lastRot: 0 });
  const [logs, setLogs] = useState([]);
  const [operador, setOperador] = useState(null);
  const [elapsed, setElapsed] = useState(0);

  // Formulario de Turno
  const [formName, setFormName] = useState('');
  const [formPunta, setFormPunta] = useState('1');
  const [formHora, setFormHora] = useState('');

  // Formulario de Lectura
  const [readTemp, setReadTemp] = useState('');
  const [readDraft, setReadDraft] = useState('');

  // 1. Inicialización de Auth
  useEffect(() => {
    const initAuth = async () => {
      await signInAnonymously(auth);
    };
    initAuth();
    const unsub = onAuthStateChanged(auth, setUser);
    return () => unsub();
  }, []);

  // 2. Sincronización en Tiempo Real
  useEffect(() => {
    if (!user) return;

    // Sincronizar Estado Maestro
    const unsubMaster = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'master'), (snap) => {
      if (snap.exists()) setMasterState(snap.data());
      else setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), { running: false, startTS: null, lastRot: 0 });
    }, (err) => console.error("Error Master:", err));

    // Sincronizar Logs
    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'registros'));
    const unsubLogs = onSnapshot(q, (snap) => {
      const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      // Ordenar en memoria (Regla 2)
      setLogs(data.sort((a, b) => b.timestamp - a.timestamp));
    }, (err) => console.error("Error Logs:", err));

    return () => {
      unsubMaster();
      unsubLogs();
    };
  }, [user]);

  // 3. Reloj y Timer de Inching
  useEffect(() => {
    const timer = setInterval(() => {
      if (masterState.running && masterState.startTS) {
        const now = Date.now();
        const diff = Math.floor((now - masterState.startTS) / 1000);
        setElapsed(diff);
      }
    }, 1000);
    return () => clearInterval(timer);
  }, [masterState.running, masterState.startTS]);

  // --- LÓGICA DE NEGOCIO ---
  const formatHMS = (s) => {
    const h = Math.floor(s / 3600).toString().padStart(2, '0');
    const m = Math.floor((s % 3600) / 60).toString().padStart(2, '0');
    const sc = (s % 60).toString().padStart(2, '0');
    return `${h}:${m}:${sc}`;
  };

  const formatMS = (s) => {
    const m = Math.floor(s / 60).toString().padStart(2, '0');
    const sc = (s % 60).toString().padStart(2, '0');
    return `${m}:${sc}`;
  };

  const handleStartTurno = () => {
    if (!formName) return;
    setOperador({ nombre: formName.toUpperCase(), punta: formPunta, hora: formHora });
  };

  const handleSaveLog = async () => {
    if (!readTemp || !operador) return;
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'registros'), {
      timestamp: Date.now(),
      elapsed: elapsed,
      op: operador.nombre,
      punta: operador.punta,
      casco: parseFloat(readTemp),
      int: Math.round(parseFloat(readTemp) * 3.5),
      draft: parseFloat(readDraft || 0)
    });
    setReadTemp('');
    setReadDraft('');
  };

  const handleConfirmRotation = async () => {
    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), { ...masterState, lastRot: elapsed });
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'registros'), {
        timestamp: Date.now(),
        elapsed: elapsed,
        op: "SISTEMA",
        type: "GIRO"
    });
  };

  const handleToggleHornada = async () => {
    const isStarting = !masterState.running;
    const update = { running: isStarting };
    if (isStarting && !masterState.startTS) {
      update.startTS = Date.now();
      update.lastRot = 0;
    }
    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), update, { merge: true });
  };

  const handleReset = async () => {
    if (!window.confirm("¿BORRAR TODO EL PROCESO?")) return;
    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), { running: false, startTS: null, lastRot: 0 });
    const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'registros'));
    for (const d of snap.docs) await deleteDoc(d.ref);
    window.location.reload();
  };

  const handlePinSubmit = () => {
    if (pin === 'ORURO2026') {
      setView('admin');
      setPin('');
    } else {
      setPin('');
      alert("PIN INCORRECTO");
    }
  };

  const downloadCSV = () => {
    const h = "Reloj;Operador;Punta;Temp_Casco;Temp_Int;Draft\n";
    const b = logs.filter(l => !l.type).map(l => `${formatHMS(l.elapsed)};${l.op};${l.punta};${l.casco};${l.int};${l.draft}`).join("\n");
    const blob = new Blob(["\uFEFF" + h + b], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `OTM_Oruro_Data.csv`;
    a.click();
  };

  // --- COMPONENTES DE VISTA ---

  const MonitorView = () => {
    const inchRemaining = Math.max(0, 900 - (elapsed - (masterState.lastRot || 0)));
    const showInchingAlert = masterState.running && inchRemaining <= 0;

    return (
      <div className="flex flex-col gap-4 p-4 animate-in fade-in duration-500">
        <header className="flex justify-between items-center bg-slate-900 p-5 rounded-3xl border border-slate-800 shadow-xl">
          <div>
            <h1 className="text-2xl font-black italic tracking-tighter">OTM <span className="text-lime-400">120H</span></h1>
            <p className="text-[9px] text-slate-500 font-bold uppercase tracking-widest mt-1">Planta Oruro • Boliviana</p>
          </div>
          <div className={`w-3 h-3 rounded-full ${masterState.running ? 'bg-lime-500 shadow-[0_0_15px_#84cc16]' : 'bg-red-500 shadow-[0_0_15px_#ef4444]'}`}></div>
        </header>

        {showInchingAlert && (
          <div className="bg-red-600 p-6 rounded-[2rem] border-4 border-red-400 text-center animate-bounce shadow-2xl">
            <RotateCw className="mx-auto mb-2 text-white animate-spin" size={32} />
            <h2 className="text-lg font-black uppercase mb-4">Girar Horno 90°</h2>
            <button 
              onClick={handleConfirmRotation}
              className="w-full py-4 bg-white text-red-700 font-black rounded-2xl uppercase shadow-lg active:scale-95 transition-all"
            >
              Confirmar Giro Realizado
            </button>
          </div>
        )}

        <div className="bg-slate-900 border border-slate-800 rounded-[2.5rem] p-8 text-center relative overflow-hidden">
            <div className="absolute top-0 left-0 h-1 bg-lime-500 transition-all duration-1000" style={{width: `${Math.min((elapsed/432000)*100, 100)}%`}}></div>
            <div className="text-6xl font-black mono tracking-tighter mb-2">{formatHMS(elapsed)}</div>
            <div className="px-4 py-1 bg-slate-950/50 rounded-full inline-block text-[10px] font-bold text-slate-500 uppercase tracking-widest">
                {masterState.running ? 'Hornada en curso' : 'Sistema en Pausa'}
            </div>
        </div>

        <div className="grid grid-cols-2 gap-3">
            <div className="bg-slate-900 p-5 rounded-3xl border border-slate-800 text-center">
                <p className="text-[10px] text-slate-500 font-bold uppercase mb-1">Temp Interna</p>
                <p className="text-4xl font-black text-lime-400 mono">{logs[0]?.int || '--'}°C</p>
            </div>
            <div className="bg-slate-900 p-5 rounded-3xl border border-slate-800 text-center">
                <p className="text-[10px] text-slate-500 font-bold uppercase mb-1">Inching En</p>
                <p className="text-4xl font-black text-orange-400 mono">{formatMS(inchRemaining)}</p>
            </div>
        </div>

        {!operador ? (
            <div className="bg-slate-900 p-6 rounded-[2rem] border border-slate-800">
                <h3 className="text-xs font-black text-blue-400 uppercase mb-4 italic flex items-center gap-2">
                    <UserCircle size={14} /> Control de Turno
                </h3>
                <input 
                  type="text" 
                  placeholder="NOMBRE OPERADOR"
                  className="w-full bg-slate-950 border border-slate-700 p-4 rounded-2xl mb-3 text-white font-bold outline-none uppercase"
                  value={formName}
                  onChange={e => setFormName(e.target.value)}
                />
                <div className="grid grid-cols-2 gap-3 mb-4">
                    <select 
                      className="bg-slate-950 border border-slate-700 p-4 rounded-2xl text-white font-bold"
                      value={formPunta}
                      onChange={e => setFormPunta(e.target.value)}
                    >
                        <option value="1">1ra Punta</option>
                        <option value="2">2da Punta</option>
                        <option value="3">3ra Punta</option>
                    </select>
                    <input 
                        type="time" 
                        className="bg-slate-950 border border-slate-700 p-4 rounded-2xl text-white font-bold"
                        value={formHora}
                        onChange={e => setFormHora(e.target.value)}
                    />
                </div>
                <button 
                    onClick={handleStartTurno}
                    className="w-full py-4 bg-blue-600 text-white font-black rounded-2xl uppercase shadow-lg active:scale-95"
                >
                    Iniciar Mi Turno
                </button>
            </div>
        ) : (
            <div className="bg-slate-900 p-6 rounded-[2rem] border border-slate-800">
                <div className="flex justify-between items-center mb-6">
                    <div>
                        <p className="text-[10px] text-slate-500 font-bold uppercase italic">Operador Actual</p>
                        <h3 className="text-xl font-black text-white">{operador.nombre}</h3>
                        <p className="text-[10px] text-blue-400 font-bold uppercase">Punta {operador.punta} • {operador.hora}</p>
                    </div>
                    <button onClick={() => setOperador(null)} className="p-3 bg-slate-800 rounded-2xl text-slate-500">
                        <X size={20} />
                    </button>
                </div>

                <div className={`space-y-4 ${!masterState.running ? 'opacity-30 pointer-events-none' : ''}`}>
                    <div className="grid grid-cols-2 gap-3">
                        <div className="bg-slate-950 p-4 rounded-2xl border border-slate-800">
                            <label className="block text-[9px] text-slate-500 uppercase font-black mb-1">Temp Casco</label>
                            <input 
                                type="number" 
                                className="w-full bg-transparent text-3xl font-black text-white outline-none mono"
                                value={readTemp}
                                onChange={e => setReadTemp(e.target.value)}
                                placeholder="0"
                            />
                        </div>
                        <div className="bg-slate-950 p-4 rounded-2xl border border-slate-800">
                            <label className="block text-[9px] text-sky-500 uppercase font-black mb-1">Draft mmca</label>
                            <input 
                                type="number" 
                                className="w-full bg-transparent text-3xl font-black text-sky-400 outline-none mono"
                                value={readDraft}
                                onChange={e => setReadDraft(e.target.value)}
                                placeholder="0.0"
                            />
                        </div>
                    </div>
                    <button 
                        onClick={handleSaveLog}
                        className="w-full py-6 bg-lime-600 text-black font-black rounded-[2rem] uppercase text-lg shadow-xl active:scale-95"
                    >
                        Guardar Registro
                    </button>
                </div>
            </div>
        )}

        <div className="grid grid-cols-2 gap-3">
            <button onClick={() => setView('tabla')} className="flex items-center justify-center gap-2 py-4 bg-slate-900 rounded-2xl border border-slate-800 text-blue-400 font-bold uppercase text-[10px]">
                <Database size={14} /> Base de Datos
            </button>
            <button onClick={downloadCSV} className="flex items-center justify-center gap-2 py-4 bg-slate-900 rounded-2xl border border-slate-800 text-green-400 font-bold uppercase text-[10px]">
                <Download size={14} /> Reporte CSV
            </button>
        </div>

        <button onClick={() => setView('login')} className="mt-8 flex items-center justify-center gap-2 text-[10px] font-black text-slate-700 uppercase tracking-widest">
            <Lock size={12} /> Ingeniería OTM
        </button>
      </div>
    );
  };

  const TableView = () => (
    <div className="p-4 bg-slate-950 min-h-screen animate-in slide-in-from-right duration-500">
        <header className="flex justify-between items-center mb-6">
            <h2 className="text-blue-400 font-black italic uppercase text-sm">Historial de Hornada</h2>
            <button onClick={() => setView('monitor')} className="bg-slate-800 px-4 py-2 rounded-xl text-[10px] font-bold uppercase text-white">Cerrar</button>
        </header>
        <div className="bg-slate-900 rounded-3xl border border-slate-800 overflow-hidden shadow-2xl">
            <table className="w-full text-left border-collapse">
                <thead className="bg-slate-950 text-[10px] font-black text-slate-500 uppercase">
                    <tr>
                        <th className="p-4">Reloj</th>
                        <th className="p-4">Op</th>
                        <th className="p-4">Temp</th>
                        <th className="p-4">Draft</th>
                    </tr>
                </thead>
                <tbody className="text-xs mono divide-y divide-slate-800">
                    {logs.map(l => (
                        <tr key={l.id} className={l.type === 'GIRO' ? 'bg-orange-500/10' : ''}>
                            <td className="p-4 text-slate-400">{formatHMS(l.elapsed)}</td>
                            <td className="p-4 font-bold text-white uppercase">{l.op}</td>
                            <td className="p-4 text-lime-400 font-bold">{l.int ? `${l.int}°` : 'GIRO'}</td>
                            <td className="p-4 text-sky-400">{l.draft || '--'}</td>
                        </tr>
                    ))}
                </tbody>
            </table>
        </div>
    </div>
  );

  const LoginView = () => (
    <div className="flex flex-col items-center justify-center min-h-screen p-8 bg-black animate-in zoom-in duration-300">
        <h2 className="text-3xl font-black italic mb-12 uppercase tracking-tighter">Acceso <span className="text-lime-400">Jefe</span></h2>
        <div className="w-full max-w-xs space-y-6">
            <input 
                type="password" 
                className="w-full bg-slate-900 border-2 border-slate-800 p-8 rounded-[2.5rem] text-center text-5xl text-lime-400 font-bold outline-none focus:border-lime-500 transition-all"
                placeholder="••••"
                value={pin}
                onChange={e => setPin(e.target.value)}
            />
            <button 
                onClick={handlePinSubmit}
                className="w-full py-6 bg-lime-500 text-black font-black rounded-3xl uppercase text-lg shadow-2xl active:scale-95 transition-transform"
            >
                Entrar al Sistema
            </button>
            <button onClick={() => setView('monitor')} className="w-full text-slate-700 font-bold uppercase text-[10px] tracking-widest mt-4">
                Regresar
            </button>
        </div>
    </div>
  );

  const AdminView = () => (
    <div className="p-6 bg-slate-950 min-h-screen animate-in fade-in duration-500">
        <header className="flex justify-between items-center mb-10">
            <h2 className="text-lime-400 font-black italic uppercase text-sm">Panel de Ingeniería</h2>
            <button onClick={() => setView('monitor')} className="bg-red-900/20 text-red-500 px-5 py-2 rounded-xl text-[10px] font-bold uppercase">Salir</button>
        </header>

        <div className="bg-slate-900 border border-slate-800 rounded-[3rem] p-12 text-center mb-8 shadow-2xl">
            <div className="text-6xl font-black text-white mono mb-2 tracking-tighter tabular-nums">{formatHMS(elapsed)}</div>
            <p className="text-[10px] font-black text-slate-500 uppercase tracking-[0.3em]">{masterState.running ? 'HORNO OPERATIVO' : 'SISTEMA DETENIDO'}</p>
        </div>

        <button 
            onClick={handleToggleHornada}
            className={`w-full py-20 rounded-[4rem] flex flex-col items-center justify-center gap-4 transition-all active:scale-95 shadow-2xl ${masterState.running ? 'bg-slate-900 text-slate-500 border border-slate-800' : 'bg-lime-500 text-black shadow-lime-500/20'}`}
        >
            {masterState.running ? <Pause size={48} fill="currentColor" /> : <Play size={48} fill="currentColor" />}
            <span className="text-4xl font-black uppercase tracking-tighter">{masterState.running ? 'PAUSAR' : 'INICIAR'}</span>
        </button>

        <div className="mt-auto pt-20">
            <button onClick={handleReset} className="w-full py-4 text-red-900 font-bold text-[9px] uppercase tracking-[0.5em] opacity-30 hover:opacity-100 transition-opacity">
                Formatear Historial de Hornada
            </button>
        </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#020617] text-white selection:bg-lime-500 selection:text-black">
      {view === 'monitor' && <MonitorView />}
      {view === 'tabla' && <TableView />}
      {view === 'login' && <LoginView />}
      {view === 'admin' && <AdminView />}
    </div>
  );
}
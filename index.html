<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OTM 120H - Oruro Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Inter:wght@400;700;900&display=swap');
        :root { --bg: #020617; --lime: #a3e635; --amber: #fbbf24; --red: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.5); }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 5px var(--red); } 50% { box-shadow: 0 0 20px var(--red); } }
        @keyframes pulse-lime { 0%, 100% { box-shadow: 0 0 5px var(--lime); } 50% { box-shadow: 0 0 20px var(--lime); } }
        .led-red { animation: pulse-red 2s infinite; background-color: var(--red); }
        .led-lime { animation: pulse-lime 2s infinite; background-color: var(--lime); }
        .view { display: none; min-height: 100vh; width: 100%; flex-direction: column; }
        .view.active { display: flex; }
        .data-table { font-size: 11px; width: 100%; border-collapse: collapse; }
        .data-table th { background: #1e293b; padding: 10px; text-align: left; text-transform: uppercase; }
        .data-table td { padding: 10px; border-bottom: 1px solid #1e293b; }
        input, select { font-size: 16px !important; }
    </style>
</head>
<body class="min-h-screen">

    <!-- MENSAJES DE ESTADO (TOASTS) -->
    <div id="toast-container" class="fixed top-5 left-1/2 -translate-x-1/2 z-[1000] w-full max-w-xs space-y-2 pointer-events-none"></div>

    <!-- PANTALLA 1: MONITOR -->
    <div id="view-monitor" class="view active p-4">
        <header class="flex justify-between items-center bg-slate-900 p-5 rounded-3xl border border-slate-800 mb-4 shadow-xl">
            <div>
                <h1 class="text-2xl font-black italic tracking-tighter leading-none">OTM <span class="text-lime-400">120H</span></h1>
                <p id="conn-status" class="text-[8px] font-bold text-slate-500 uppercase tracking-widest mt-1 italic">Modo Local</p>
            </div>
            <div id="led-main" class="w-4 h-4 rounded-full bg-slate-700 transition-all duration-500"></div>
        </header>

        <!-- ALERTA INCHING -->
        <div id="alert-inching" class="hidden mb-4 p-5 bg-amber-500 text-black rounded-3xl border-2 border-amber-400 text-center animate-bounce shadow-2xl">
            <div class="flex items-center justify-center gap-3 mb-2">
                <i data-lucide="rotate-cw" class="animate-spin text-black"></i>
                <span class="text-sm font-black uppercase italic">¬°Girar Horno Ahora!</span>
            </div>
            <button id="btn-confirm-giro" class="w-full py-3 bg-black text-white font-black uppercase rounded-xl shadow-xl">‚úì Giro 90¬∞ Realizado</button>
        </div>

        <!-- RELOJ -->
        <div class="glass rounded-[2.5rem] p-8 text-center mb-4 shadow-2xl relative overflow-hidden">
            <div id="progress-bar" class="absolute top-0 left-0 h-1.5 bg-lime-500 transition-all duration-1000" style="width: 0%"></div>
            <div id="phase-badge" class="absolute top-4 right-4 px-3 py-1 bg-slate-950 rounded-full text-[9px] font-black text-slate-500 uppercase border border-slate-800 tracking-widest">Fase --</div>
            <div id="clock-main" class="mono text-6xl font-bold text-white mb-2 tracking-tighter tabular-nums">00:00:00</div>
            <div id="status-badge" class="inline-block px-3 py-1 bg-slate-800 text-slate-400 rounded-full text-[10px] font-black uppercase tracking-widest">Detenido</div>
        </div>

        <!-- M√âTRICAS -->
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="bg-slate-900 p-5 rounded-[2rem] border border-slate-800 text-center shadow-lg">
                <p class="text-[9px] font-bold text-slate-500 uppercase mb-1">Temp Interna</p>
                <p id="val-temp" class="text-4xl font-black text-lime-400 mono">--¬∞C</p>
                <p class="text-[8px] text-slate-600 mt-1 uppercase italic font-bold">Est. 3.5x</p>
            </div>
            <div class="bg-slate-900 p-5 rounded-[2rem] border border-slate-800 text-center shadow-lg">
                <p class="text-[9px] font-bold text-slate-500 uppercase mb-1">Presi√≥n Draft</p>
                <p id="val-press" class="text-4xl font-black text-sky-400 mono">--</p>
                <p class="text-[8px] text-slate-600 mt-1 uppercase italic font-bold">mmca</p>
            </div>
        </div>

        <!-- TURNO -->
        <div id="section-turno" class="bg-slate-900 rounded-3xl p-5 border border-slate-800 mb-4 shadow-xl">
            <div id="form-turno">
                <h3 class="text-xs font-bold text-blue-400 uppercase mb-3 flex items-center gap-2">üîÑ Cambio de Turno</h3>
                <input type="text" id="in-op-name" class="w-full bg-slate-950 border border-zinc-700 rounded-xl px-4 py-3 text-sm text-white mb-3 uppercase font-bold outline-none focus:border-blue-500" placeholder="NOMBRE COMPLETO">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input type="time" id="in-op-time" class="w-full bg-slate-950 border border-zinc-700 rounded-xl px-4 py-3 text-sm text-white font-bold outline-none">
                    <select id="in-op-punta" class="w-full bg-slate-950 border border-zinc-700 rounded-xl px-4 py-3 text-sm text-white font-bold outline-none">
                        <option value="1">1ra Punta</option><option value="2">2da Punta</option><option value="3">3ra Punta</option>
                    </select>
                </div>
                <button id="btn-start-turno" class="w-full py-4 bg-blue-600 text-white font-black rounded-xl uppercase text-sm shadow-lg active:scale-95 transition-all">Iniciar Mi Turno</button>
            </div>
            <div id="display-turno" class="hidden">
                <div class="bg-gradient-to-br from-blue-700 to-blue-500 rounded-2xl p-4 mb-3 text-center shadow-lg">
                    <p id="txt-op-name" class="text-lg font-black text-white uppercase tracking-tighter">--</p>
                    <p id="txt-op-info" class="text-[10px] text-blue-100 uppercase mt-1">Punta -- | Ingreso: --</p>
                </div>
                <button id="btn-end-turno" class="w-full py-2 bg-slate-800 text-slate-400 font-bold rounded-xl text-[10px] uppercase">Cerrar Turno / Cambiar</button>
            </div>
        </div>

        <!-- REGISTRO -->
        <div id="section-registro" class="bg-slate-900 rounded-[2.5rem] p-6 border border-slate-800 mb-4 opacity-30 pointer-events-none shadow-2xl transition-all duration-500">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-slate-950 p-4 rounded-3xl border border-slate-800">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Carcasa</label>
                    <input type="number" id="in-shell" class="w-full bg-transparent text-3xl font-black text-white outline-none mono" placeholder="0" inputmode="decimal">
                </div>
                <div class="bg-slate-950 p-4 rounded-3xl border border-slate-800">
                    <label class="block text-[10px] font-bold text-sky-500 uppercase mb-1">Draft</label>
                    <input type="number" id="in-draft" step="0.1" class="w-full bg-transparent text-3xl font-black text-sky-400 outline-none mono" placeholder="0.0" inputmode="decimal">
                </div>
            </div>
            <button id="btn-save-log" class="w-full py-6 bg-lime-600 text-black font-black rounded-3xl uppercase text-lg shadow-xl shadow-lime-500/20 active:scale-95">Guardar Lectura</button>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-4">
            <button id="btn-show-tabla" class="py-4 bg-slate-800 text-blue-400 font-bold rounded-2xl uppercase text-[10px] border border-slate-700">üìä Ver Tabla</button>
            <button id="btn-export" class="py-4 bg-slate-800 text-green-400 font-bold rounded-2xl uppercase text-[10px] border border-slate-700">‚¨áÔ∏è Exportar CSV</button>
        </div>

        <button id="btn-to-admin-login" class="w-full mt-6 py-4 bg-slate-900 text-slate-600 font-bold rounded-2xl text-[10px] uppercase border border-slate-800">üîí Ingenier√≠a OTM</button>
    </div>

    <!-- PANTALLA 2: TABLA -->
    <div id="view-tabla" class="view p-4 bg-slate-950">
        <header class="flex justify-between items-center mb-4">
            <h2 class="text-blue-400 font-black uppercase text-sm italic">Base de Datos</h2>
            <button id="btn-back-from-tabla" class="bg-slate-800 text-white px-5 py-2 rounded-xl text-[10px] font-bold uppercase">Cerrar</button>
        </header>
        <div class="bg-slate-900 rounded-3xl overflow-x-auto border border-slate-800 shadow-2xl flex-1">
            <table class="data-table">
                <thead><tr><th>Hora</th><th>Op</th><th>Casco</th><th>Int</th><th>Draft</th></tr></thead>
                <tbody id="table-body" class="mono text-white/80"></tbody>
            </table>
        </div>
    </div>

    <!-- PANTALLA 3: LOGIN ADMIN -->
    <div id="view-login" class="view p-6 items-center justify-center bg-black">
        <div class="w-full max-w-xs text-center">
            <h2 class="text-3xl font-black italic mb-8 uppercase tracking-tighter">Acceso <span class="text-lime-400">Jefe</span></h2>
            <input type="password" id="in-pin" class="w-full bg-slate-900 border-2 border-slate-700 p-6 rounded-[2rem] text-center text-4xl text-lime-400 font-bold mb-6 outline-none focus:border-lime-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <button id="btn-submit-pin" class="w-full py-6 bg-lime-500 text-black font-black rounded-3xl uppercase text-lg shadow-xl shadow-lime-500/20 active:scale-95 transition-transform">Entrar</button>
            <button id="btn-back-from-login" class="mt-8 text-slate-600 font-bold uppercase text-[10px] tracking-widest">Cancelar</button>
        </div>
    </div>

    <!-- PANTALLA 4: ADMIN PANEL -->
    <div id="view-admin" class="view p-4 bg-slate-950">
        <header class="flex justify-between items-center mb-6">
            <h2 class="text-lime-400 font-black italic uppercase text-sm">Control Maestro</h2>
            <button id="btn-back-from-admin" class="bg-red-900/30 text-red-500 px-5 py-2 rounded-xl text-[10px] font-bold uppercase">Salir</button>
        </header>
        <div class="bg-slate-900 border border-slate-800 rounded-[2.5rem] p-8 text-center mb-6 shadow-2xl">
            <div id="clock-admin" class="mono text-5xl font-bold text-lime-400 mb-1 tracking-tighter">00:00:00</div>
            <p id="admin-status-text" class="text-[10px] font-black text-slate-500 uppercase tracking-widest italic">Sistema Pausado</p>
        </div>
        <button id="btn-master-toggle" class="w-full py-16 rounded-[3.5rem] bg-lime-500 text-black font-black text-4xl uppercase shadow-2xl active:scale-95 transition-all">INICIAR</button>
        <button id="btn-hard-reset" class="w-full mt-24 py-3 text-red-900 font-bold text-[9px] uppercase tracking-[0.4em] opacity-30">Reset Total</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, orderBy, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==================== CONFIGURACI√ìN Y ESTADO ====================
        const PIN_MASTER = "ORURO2026";
        let db = null;
        let appId = "otm-master-v1";
        let state = { running: false, startTS: null, lastRotation: 0 };
        let logs = [];
        let userTurno = null;
        let elapsedS = 0;

        // ==================== TOAST NOTIFIER ====================
        const showToast = (msg, type = 'info') => {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = `p-4 rounded-2xl shadow-2xl border text-sm font-bold text-white transition-all transform translate-y-10 opacity-0 bg-slate-900 border-slate-700`;
            if (type === 'error') el.classList.add('border-red-500', 'text-red-400');
            if (type === 'success') el.classList.add('border-lime-500', 'text-lime-400');
            el.innerText = msg;
            container.appendChild(el);
            setTimeout(() => { el.classList.remove('translate-y-10', 'opacity-0'); }, 10);
            setTimeout(() => { el.classList.add('opacity-0'); setTimeout(() => el.remove(), 500); }, 3000);
        };

        // ==================== INICIALIZACI√ìN FIREBASE ====================
        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            db = getFirestore(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'otm-v4-prod';

            signInAnonymously(auth).then(() => {
                onAuthStateChanged(auth, u => {
                    if (u) {
                        document.getElementById('conn-status').innerText = "Cloud Sincronizado";
                        document.getElementById('conn-status').classList.add('text-lime-500');
                        syncCloud();
                    }
                });
            });
        } catch (e) {
            console.warn("Iniciando en Modo Local √∫nicamente.");
            showToast("Modo Local: Cambios no se guardar√°n en la nube.", "error");
        }

        const syncCloud = () => {
            if (!db) return;
            // Sincronizar Master
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'master'), (snap) => {
                if(snap.exists()) { state = snap.data(); updateUI(); }
                else { setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'master'), state); }
            });
            // Sincronizar Logs
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snap) => {
                logs = snap.docs.map(d => d.data());
                renderLogs();
            });
        };

        // ==================== L√ìGICA DE TIEMPO ====================
        setInterval(() => {
            if (state.running && state.startTS) {
                elapsedS = Math.floor((Date.now() - state.startTS) / 1000);
                const hrs = elapsedS / 3600;
                const timeStr = formatHMS(elapsedS);
                
                document.getElementById('clock-main').innerText = timeStr;
                document.getElementById('clock-admin').innerText = timeStr;
                document.getElementById('progress-bar').style.width = Math.min((hrs/120)*100, 100) + '%';
                
                // Inching (15 min = 900s)
                const sinceRot = elapsedS - (state.lastRotation || 0);
                const remaining = Math.max(0, 900 - sinceRot);
                document.getElementById('inch-timer').innerText = formatMinSec(remaining);
                document.getElementById('alert-inching').classList.toggle('hidden', remaining > 0);

                // Fases
                let p = "1: Secado", r = 5;
                if(hrs > 80) { p = "3: Vitrif."; r = 12; } else if(hrs > 40) { p = "2: Qu√≠mico"; r = 8; }
                document.getElementById('phase-badge').innerText = p;
                document.getElementById('current-ramp').innerText = r;
            }
        }, 1000);

        function formatHMS(s) {
            const h = Math.floor(s/3600).toString().padStart(2,'0');
            const m = Math.floor((s%3600)/60).toString().padStart(2,'0');
            const sc = (s%60).toString().padStart(2,'0');
            return `${h}:${m}:${sc}`;
        }
        function formatMinSec(s) {
            const m = Math.floor(s/60).toString().padStart(2,'0');
            const sc = (s%60).toString().padStart(2,'0');
            return `${m}:${sc}`;
        }

        // ==================== MANEJO DE VISTAS ====================
        const showView = (id) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0,0);
        };

        // ==================== VINCULACI√ìN DE BOTONES ====================
        // Monitor -> Otros
        document.getElementById('btn-to-admin-login').addEventListener('click', () => showView('view-login'));
        document.getElementById('btn-show-tabla').addEventListener('click', () => {
            renderTabla();
            showView('view-tabla');
        });
        document.getElementById('btn-back-from-tabla').addEventListener('click', () => showView('view-monitor'));
        document.getElementById('btn-back-from-login').addEventListener('click', () => showView('view-monitor'));
        document.getElementById('btn-back-from-admin').addEventListener('click', () => showView('view-monitor'));

        // PIN Validation
        document.getElementById('btn-submit-pin').addEventListener('click', () => {
            const val = document.getElementById('in-pin').value;
            if (val === PIN_MASTER) {
                document.getElementById('in-pin').value = '';
                showView('view-admin');
            } else {
                showToast("Pin Incorrecto", "error");
                document.getElementById('in-pin').value = '';
            }
        });

        // Turno
        document.getElementById('btn-start-turno').addEventListener('click', () => {
            const name = document.getElementById('in-op-name').value.trim();
            if(!name) return showToast("Ingrese su nombre", "error");
            userTurno = {
                name: name.toUpperCase(),
                punta: document.getElementById('in-op-punta').value,
                time: document.getElementById('in-op-time').value
            };
            document.getElementById('txt-op-name').innerText = userTurno.name;
            document.getElementById('txt-op-info').innerText = `Punta ${userTurno.punta} | Ingreso: ${userTurno.time}`;
            document.getElementById('form-turno').classList.add('hidden');
            document.getElementById('display-turno').classList.remove('hidden');
            updateUI();
            showToast("Turno Iniciado", "success");
        });

        document.getElementById('btn-end-turno').addEventListener('click', () => {
            userTurno = null;
            document.getElementById('form-turno').classList.remove('hidden');
            document.getElementById('display-turno').classList.add('hidden');
            updateUI();
        });

        // Registro de Datos
        document.getElementById('btn-save-log').addEventListener('click', async () => {
            const shell = document.getElementById('in-shell').value;
            const draft = document.getElementById('in-draft').value || 0;
            if(!shell) return showToast("Ingrese temperatura", "error");

            const log = {
                timestamp: Date.now(),
                elapsed: elapsedS,
                op: userTurno.name,
                shell: parseFloat(shell),
                int: Math.round(parseFloat(shell) * 3.5),
                draft: parseFloat